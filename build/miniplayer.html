<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Miniplayer</title>
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      overflow: hidden;
      -webkit-app-region: drag;
      user-select: none;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    #container {
      display: flex;
      height: 120px;
      width: 600px;
      background: #111;
      border-radius: 8px;
    }
    #artwork {
      width: 120px;
      height: 120px;
      background-size: cover;
      background-position: center;
      position: relative;
      border-radius: 8px 0 0 8px;
    }
    #visualizer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
    }
    #info-controls {
      flex: 1;
      padding: 10px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    #songName {
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #controls {
      display: flex;
      justify-content: center;
    }
    .control-btn {
      background: none;
      border: none;
      cursor: pointer;
      -webkit-app-region: no-drag;
      font-size: 20px;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .control-btn:hover {
      color: #a88cff;
      transform: scale(1.1);
    }
    .control-btn img {
      width: 20px;
      height: 20px;
      filter: brightness(0) invert(1);
    }
    #closeBtn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: none;
      border: none;
      cursor: pointer;
      -webkit-app-region: no-drag;
      color: #fff;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="artwork">
      <canvas id="visualizer"></canvas>
    </div>
    <div id="info-controls">
      <div id="songName">No Track</div>
      <div id="controls">
        <button id="prevBtn" class="control-btn">
         <img src="skipLeft.svg" alt="Play" class="icon" />
        </button>
        <button id="playPauseBtn" class="control-btn">
          <img src="play.svg" alt="Play" class="icon" />
        </button>
        <button id="nextBtn" class="control-btn">
         <img src="skipRight.svg" alt="Play" class="icon" />
        </button>
      </div>
    </div>
  </div>
  <button id="closeBtn">Ã—</button>
  <script>
    const canvas = document.getElementById('visualizer');
    const ctx = canvas.getContext('2d');
    const artworkDiv = document.getElementById('artwork');
    const songNameElem = document.getElementById('songName');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const playPauseIcon = playPauseBtn.querySelector('img');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const closeBtn = document.getElementById('closeBtn');

    let isPlaying = false;
    let themeColor = '#a88cff';
    let isRainbowActive = false;
    let rainbowHue = 0;
    let rainbowFrameId;

    function resizeCanvas() {
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    window.electronAPI.onUpdateTrack((data) => {
      if (data.songName) songNameElem.textContent = data.songName;
      if (data.artUrl) artworkDiv.style.backgroundImage = `url(${data.artUrl})`;
      isPlaying = data.isPlaying;
      playPauseIcon.src = isPlaying ? 'pause.svg' : 'play.svg';
      playPauseIcon.alt = isPlaying ? 'Pause' : 'Play';
    });

    window.electronAPI.onUpdateVisualizer((dataArray) => {
      drawVisualizer(new Uint8Array(dataArray));
    });

    window.electronAPI.onUpdateTheme((data) => {
      themeColor = data.color;
      isRainbowActive = data.isRainbow;
      if (isRainbowActive) {
        startRainbowColorLoop();
      } else {
        stopRainbowColorLoop();
      }
    });

    function drawVisualizer(dataArray) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const bufferLength = dataArray.length;
      const barWidth = (canvas.width / bufferLength) * 1.5;
      const halfCount = Math.floor(bufferLength / 2);
      const centerX = canvas.width / 2;

      for (let i = 0; i < halfCount; i++) {
        const barHeight = dataArray[i] * (canvas.height / 255) * 0.5;
        ctx.fillStyle = themeColor;
        ctx.fillRect(centerX - (i + 1) * barWidth, canvas.height - barHeight, barWidth / 2, barHeight);
        ctx.fillRect(centerX + i * barWidth, canvas.height - barHeight, barWidth / 2, barHeight);
      }
    }

    function startRainbowColorLoop() {
      function updateHue() {
        if (!isRainbowActive) return;
        rainbowHue = (rainbowHue + 1) % 360;
        themeColor = `hsl(${rainbowHue}, 100%, 65%)`;
        requestAnimationFrame(updateHue);
      }
      if (!rainbowFrameId) {
        rainbowFrameId = requestAnimationFrame(updateHue);
      }
    }

    function stopRainbowColorLoop() {
      if (rainbowFrameId) {
        cancelAnimationFrame(rainbowFrameId);
        rainbowFrameId = null;
      }
    }

    prevBtn.addEventListener('click', () => {
      console.log('Previous button clicked');
      window.electronAPI.playPrevious();
    });
    nextBtn.addEventListener('click', () => {
      console.log('Next button clicked');
      window.electronAPI.playNext();
    });
    playPauseBtn.addEventListener('click', () => {
      console.log('Play/Pause button clicked');
      window.electronAPI.togglePlay();
    });
    closeBtn.addEventListener('click', () => {
      console.log('Close button clicked');
      window.electronAPI.toggleMiniplayer();
    });
  </script>
</body>
</html>