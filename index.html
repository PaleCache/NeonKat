
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NeonKat</title>
  <script src="jsmediatags.min.js"></script>
  <script src="hls.js@latest"></script>
  <style>
    :root {
      --primary-color: #a88cff;
      --primary-dark: #7a5fff;
    }

    
    body {
      margin: 0;
      padding: 0;                  
      background: transparent;
      color: #fff;
      font-family: 'Arial', sans-serif;
      display: flex;
      justify-content: center;
      align-items: flex-start;     
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      outline: none !important;
      border-radius: 3px;
    }

#visualizerControls,
#hamburgerBtn,
#playlist li,
#chooseFolder,
#addStreamBtn,
#sortBtn,
#miniPlayerBtn,
#notifyToggleBtn,
#visualizerToggleBtn,
#rainbowToggleBtn,
button,
#exportDurationSelect:focus,
#exportDurationSelect:focus-visible,
#customExportSeconds:focus,
#customExportSeconds:focus-visible

a {
  
    outline: none !important;
}


.control-btn img,
#topControls img,
.icon {
  -webkit-app-region: no-drag !important;
  pointer-events: auto !important;
    outline: none !important;
}


    .control-btn img,
    .icon,
    #topControls img,
    #bellIcon,
    #visualizerIcon,
    #rainbowIcon,
    #miniPlayerBtn img {
      filter: brightness(0) invert(1) !important;
    }
      #container {
        width: 441px;            
        height: 743px;               
        max-width: none;
        max-height: none;
        background: #111;
        padding: 15px;
        border-radius: 3px;
        border: 6px solid var(--primary-color); 
        box-sizing: border-box;      
        display: flex;
        flex-direction: column;
        overflow: hidden;
        margin-top: 0;             
      }
    h1 {
      font-size: 24px;
      text-align: center;
      margin: 0 0 10px;
      color: #ffffff;
      margin-left: 145px;
    }
    #chooseFolder {
      background: #212121;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      margin-bottom: 10px;
      font-size: 14px;
      -webkit-app-region: no-drag;
    }
    #chooseFolder:hover {
      background: var(--primary-color);
    }
    #savePlaylistBtn, #loadPlaylistBtn, #sortBtn {
      background: #212121;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      margin-bottom: 10px;
      font-size: 14px;
      -webkit-app-region: no-drag;
    }
    #savePlaylistBtn:hover, #loadPlaylistBtn:hover, #sortBtn:hover {
      background: var(--primary-color);
    }
    #playlist,
    #playlist li {
      user-select: none !important;
      -webkit-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
    }
    #selectedFolderName {
      font-size: 14px;
      color: var(--primary-color);
      text-align: center;
      margin-bottom: 10px;
      -webkit-app-region: no-drag;
    }
    #sortMenu {
      position: absolute;
      background: rgba(34, 34, 34, 0.51) !important;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
      z-index: 10;
      display: none;
      width: 150px;
      -webkit-app-region: no-drag;
      backdrop-filter: blur(8px) !important;
    }
    #sortMenu button {
      background: rgba(34, 34, 34, 0);
      color: white;
      border: none;
      padding: 10px;
      width: 100%;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      -webkit-app-region: no-drag;
      border-radius: 10px;
    }
    #sortMenu button:hover {
      background: var(--primary-color);
    }
  
  #playlist {
  list-style: none;
  padding: 0;
  margin: 0 0 15px;
  flex: 1;                    
  min-height: 150px;
  max-height: 270px;         
  overflow-y: auto;
  background: #222;
  border-radius: 5px;
  -webkit-app-region: no-drag;
    background: rgba(33, 33, 33, 0.5) !important;
    backdrop-filter: blur(4px) !important; 
}
    #playlist li {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 12px;
    }
    #playlist li:last-child {
      border-bottom: none;
    }
    #playlist li:hover {
      background: var(--primary-color);
    }
    #playlist li.active {
      background: #0c0c0c;
      color: #fff;
    }
    #playlist::-webkit-scrollbar {
      width: 8px;
    }
    #playlist::-webkit-scrollbar-track {
      background: #111;
      border-radius: 5px;
      background: rgba(33, 33, 33, 0.5) !important;
      backdrop-filter: blur(4px) !important; 
    }
    #playlist::-webkit-scrollbar-thumb {
      background: linear-gradient(to bottom, #212121, var(--primary-color));
      border-radius: 5px;
    }
    #playlist::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(to bottom, var(--primary-color), #b19cd9);
    }
    input[type="range"] {
      appearance: none;
      width: 100%;
      height: 5px;
      background: #444;
      border-radius: 5px;
      outline: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 12px;
      height: 12px;
      background: var(--primary-color);
      border-radius: 50%;
      cursor: pointer;
      border: none;
      position: relative;
      z-index: 2;
    }
    input[type="range"]::-moz-range-thumb {
      width: 12px;
      height: 12px;
      background: var(--primary-color);
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }
    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      gap: 10px;
      flex-wrap: wrap;
      -webkit-app-region: no-drag;
    }
    .control-btn.repeat-enabled {
      background: var(--primary-color) !important;
      color: #fff;
      -webkit-app-region: no-drag;
    }
    .control-btn.enabled {
      background-color: var(--primary-color) !important;
      color: white !important;
    }
    .control-btn {
      background: #212121;
      color: white;
      border: none;
      padding: 10px 0;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      flex: 1 1 0;
      text-align: center;
      white-space: nowrap;
      height: 38px;
      line-height: 1.2;
      -webkit-app-region: no-drag;
    }
    .control-btn:hover {
      background: var(--primary-color) !important;
    }

    * {
  transition: none !important;
}
    #volume {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      width: 100px;
      height: 5px;
      background: #444;
      outline: none;
      border-radius: 5px;
      margin-left: 10px;
      -webkit-app-region: no-drag;
    }
    #volume::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 12px;
      height: 12px;
      background: var(--primary-color);
      border-radius: 50%;
      cursor: pointer;
      -webkit-app-region: no-drag;
    }
    #volume::-moz-range-thumb {
      -moz-appearance: none;
      appearance: none;
      width: 12px;
      height: 12px;
      background: var(--primary-color);
      border-radius: 50%;
      cursor: pointer;
      -webkit-app-region: no-drag;
    }
    #visualizer {
      width: 100%;
      height: 164px;
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 10px;
      position: relative;
      background-size: 100% 100%;
      -webkit-app-region: no-drag;
    }
    #progressContainer {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
      font-size: 12px;
      color: #ffffff;
      -webkit-app-region: no-drag;
    }
    #progressBar {
      flex: 1;
      height: 6px;
      background: #444;
      border-radius: 3px;
      -webkit-appearance: none;
      appearance: none;
      -webkit-app-region: no-drag;
    }
    #progressBar::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 12px;
      height: 12px;
      background: var(--primary-color);
      border-radius: 50%;
      cursor: pointer;
    }
    #progressBar::-moz-range-thumb {
      width: 12px;
      height: 12px;
      background: var(--primary-color);
      border-radius: 50%;
      cursor: pointer;
    }
    footer {
      text-align: right;
      font-size: 9px;
      font-weight: bold;
      color: #ffffff;  
      pointer-events: none;
      height: 13px !important;
      z-index: 9999999;
    }


    #streamUrlInput:focus,
      #streamNameInput:focus,
      #ytUrlInput,
      #jellyfinServerInput,
      #jellyfinUserInput,
      #jellyfinPassInput,
      #jellyfinSearchInput,
      #playlistQuickSearch,
      #customBgInput,
      #videoQualitySelect {
        outline: none !important;
    }

#playlist li.selected {
  background: var(--primary-color) !important;
  color: #000;
  font-weight: bold;
}

#playlist li.selected.active {
  background: var(--primary-color) !important;
  font-weight: bold;
}

    title {
    text-align: center;
      font-size: 12px;
      color: #ffffff;
        font-weight: bold;

    }
    .icon {
      width: 20px;
      height: 20px;
      object-fit: contain;
      filter: brightness(0) invert(1);
    }
    #topControls {
      display: flex;
      align-items: center;
      gap: 0px;
      margin-bottom: 1px;
      flex-wrap: nowrap;
      -webkit-app-region: drag;
          width: 173px;
    }
    #visualizerControls {
      display: flex;
      align-items: center;
      gap: 5px;
      -webkit-app-region: no-drag;
    }
    #visualizerColor {
      height: 20px;
      width: 20px;
      padding: 0;
      border: none;
      background: #111111;
      cursor: pointer;
    }

    #visualizerCanvas{
     background-size: revert-layer !important;

    }

    #contextMenu button:hover {
      background: var(--primary-color);
    }

    #contextMenu button:active {
      background: var(--primary-color);
    }
    body.mini-mode #container {
      width: 260px !important;
      height: 290px !important;    
      padding: 10px !important;    
      box-sizing: border-box !important;
    }

    body.mini-mode h1,
    body.mini-mode #playlist,
    body.mini-mode #playlistControls,
    body.mini-mode #sortBtn,
    body.mini-mode #sortMenu,
    body.mini-mode #chooseFolder,
    body.mini-mode #addStreamBtn,
    body.mini-mode #hamburgerMenu,
    body.mini-mode #hamburgerBtn,
    body.mini-mode #connectJellyfinBtn
    {
      display: none !important;
    }

    body.mini-mode .controls {
      margin-top: 5px;
    }

  body.mini-mode #visualizer {
    height: 105px !important;
    background-position: center !important;
    image-rendering: pixelated;
}


body.mini-mode #visualizerVideo {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 106px;
    object-fit: cover;
    z-index: 0;
    border-radius: inherit;
}



    #hamburgerMenu button:hover {
  background: var(--primary-color) !important;
  color: black !important;
}

#hamburgerMenu {

  backdrop-filter: blur(8px) !important;
background: rgba(34, 34, 34, 0.51) !important;
    border-radius: 10px !important;
}

#hamburgerBtn svg {
  filter: brightness(0) invert(1);
}

#hamburgerBtn:hover svg {
  stroke: var(--primary-color);
}

#visualizerWrapper {
    position: relative;
    width: 100%;
    height: 225px;
    overflow: initial;
    border-radius: 8px;
}

#skipVideoToggle {
  width: 40px;
  height: 20px;
  background: #444;
  border-radius: 10px;
  position: relative;
  cursor: pointer;
  transition: background 0.2s;
}

#skipVideoThumb {
  width: 18px;
  height: 18px;
  background: #333;
  border-radius: 50%;
  position: absolute;
  top: 1px;
  left: 1px;
  transition: left 0.2s;
}

#skipVideoToggle.toggle-on {
  background: rgb(60,60,60);
}

#skipVideoToggle.toggle-on #skipVideoThumb {
  left: 21px;
}

#visualizer {
  position: absolute;
  inset: 0;
  z-index: 1;
  pointer-events: none;
  background-color: transparent;
  
}

#visualizerOverlay {
  position: absolute;
  inset: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2;
  pointer-events: none;
  color: white;
  font-size: 16px;
  font-weight: bold;
  text-shadow: 0 0 4px black;
}


.vis-mode-toggle {
  width: 100%;
  padding: 14px 20px;
  background: none;
  border: none;
  color: white;
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.vis-mode-toggle:last-child {
  border-bottom: none;
}

.vis-mode-toggle .label {
  font-weight: normal;
}

.vis-mode-toggle .switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 26px;
  right: 27px;
}

.vis-mode-toggle .switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.vis-mode-toggle .slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #444;
  transition: .3s;
  border-radius: 26px;
}

.vis-mode-toggle .slider:before {
  position: absolute;
  content: "";
  height: 22px;
  width: 22px;
  left: 2px;
  bottom: 2px;
  background-color: #666;
  transition: .3s;
  border-radius: 50%;
  box-shadow: 0 2px 5px rgba(0,0,0,0.4);
}

.vis-mode-toggle input:checked + .slider {
  background-color: var(--primary-color);
}

.vis-mode-toggle input:checked + .slider:before {
  transform: translateX(24px);
  background-color: #111;
}



.vis-mode-toggle {
  cursor: pointer;
  user-select: none;
}

.vis-mode-toggle > * {
  pointer-events: none;
}

.sort-btn:hover {
  background: var(--primary-color);
  color: #000;
  transform: translateY(-1px);
}

#closeSortMenuBtn {
  width: 100%;
  padding: 10px;
  margin-top: 8px;       
  color: white !important;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  font-weight: bold;
  transition: background 0.18s ease, transform 0.15s ease;
}

#sortMenu #closeSortMenuBtn:hover {
  background: var(--primary-color) !important;
  transform: translateY(-1px);
}

#sortMenu #closeSortMenuBtn:active {
  transform: translateY(0);
  opacity: 0.92;
}


#customBgToggle {
    margin-right: auto !important;
    width: 91%;
    font-size: 14px;
}

#customBgToggle:hover {
  background: rgba(var(--primary-color), 0.15);
}

 #loadPlaylistBtn, #savePlaylistBtn, #chooseFolder, #sortBtn, .control-btn, .vis-mode-toggle button {
  background: rgba(33, 33, 33, 0.5);   
  backdrop-filter: blur(4px) !important;          
  color: white !important;
}

#jellyfinModal, #streamModal, #aboutModal, #ytModal,#customBgModal {
  border-radius: 3px;
}

#ytModal > div,
#streamModal > div,
#jellyfinModal > div,
#customBgModal > div,
#aboutModal > div {
backdrop-filter: blur(8px) !important;
background: rgba(34, 34, 34, 0.51) !important;
}


button:hover, .control-btn:hover, .vis-mode-toggle button:hover {
  background: var(--primary-color) !important; 
}


#notifyToggleBtn,
#gifPreviewToggleBtn,
#visualizerToggleBtn,
#rainbowToggleBtn,
#miniPlayerBtn,
#hamburgerBtn,
#clearQuickSearch {
  background: none !important; 
  backdrop-filter: none !important;
  border: none !important;
  box-shadow: none !important;
}

#notifyToggleBtn:hover,
#gifPreviewToggleBtn:hover,
#visualizerToggleBtn:hover,
#rainbowToggleBtn:hover,
#miniPlayerBtn:hover,
#hamburgerBtn:hover,
#clearQuickSearch:hover {
  background: none !important;
  transform: none !important;
}




#container.custom-bg::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(17, 17, 17, 0.65);
  border-radius: 0px;               
  pointer-events: none;               
  z-index: 1;                         
}

#container.custom-bg {
  position: relative;         
  background-size: cover !important;
  background-position: center !important;
  background-repeat: no-repeat !important;
}


#container > * {
  position: relative;
  z-index: 2;
}


.sort-wrapper {
  z-index: 100 !important;  
}


#sortMenu {
  z-index: 101 !important;
  pointer-events: auto !important;
}

#hamburgerMenu #custom-set-btn,
#hamburgerMenu button#custom-set-btn,
#custom-set-btn,
#customBgToggle button {
  background: #434242 !important;
  color: white !important;
  pointer-events: auto !important;
}

#hamburgerMenu #custom-set-btn:hover,
#hamburgerMenu button#custom-set-btn:hover,
#custom-set-btn:hover,
#customBgToggle button:hover {
  background: var(--primary-color) !important;
  color: #000000 !important;
  outline: none !important;
}


#visualizerVideo {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 164px;          
    object-fit: cover;
    z-index: 0;
    border-radius: inherit;
    background: transparent;  
}

body.minimized * {
  backdrop-filter: none !important;
  box-shadow: none !important;
}


body.low-perf #playlist,
body.low-perf #sortMenu,
body.low-perf #hamburgerMenu,
body.low-perf button,
body.low-perf .control-btn,
body.low-perf .vis-mode-toggle button,
body.low-perf #container,
body.low-perf #container > * {
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
  filter: none !important;
}


body.low-perf #playlist,
body.low-perf #sortMenu,
body.low-perf #hamburgerMenu,
body.low-perf #streamModal > div,
body.low-perf #jellyfinModal > div,
body.low-perf #aboutModal > div,
body.low-perf #ytModal > div,
body.low-perf #customBgModal > div,
body.low-perf #chooseFolder,
body.low-perf #sortBtn,
body.low-perf button.control-btn,
body.low-perf .vis-mode-toggle button,
body.low-perf #container {
  background: #222 !important;        
  background-image: none !important;
  opacity: 1 !important;            
}


body.low-perf .bars-gif-wrapper,
body.low-perf img[src*="bars.gif"],
body.low-perf #visualizerBgGif {
  display: none !important;
}


body.video-only {
  background: #000 !important;
  overflow: hidden !important;
}

body.video-only #container {
  padding: 0 !important;
  border: none !important;
  background: #000 !important;
  border-radius: 10 !important;
  overflow: hidden !important;
  width: 100% !important;
  height: 100vh !important;
  margin: 0 !important;
  box-sizing: border-box !important;
  
 
}



body.video-only #visualizerVideo {
  position: fixed !important;
  inset: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  object-fit: cover !important;
  z-index: 1 !important;
  border-radius: 0 !important;
}



body.video-only #visualizer .song-title-overlay {
  position: absolute;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%);
  color: white;
  font-size: 28px;
  font-weight: bold;
  text-shadow: 0 0 10px black, 0 0 20px black;
  z-index: 15;
  pointer-events: none;
  max-width: 90%;
  text-align: center;
  padding: 0 20px;
}


body.video-only #playlist,
body.video-only h1,
body.video-only #topControls,
body.video-only #playlistControls,
body.video-only #sortBtn,
body.video-only #chooseFolder,
body.video-only #addStreamBtn,
body.video-only #connectJellyfinBtn,
body.video-only #visualizerBgGif,
body.video-only #visualizer {
  display: none !important;
}


#popoutVideoBtn {
  position: absolute;
  top: 33px;
  right: 11px;
  z-index: 9999;
  background: rgba(33, 33, 33, 0.5) !important;
  border: none;
  border-radius: 50%;
  width: 12px;
  height: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  backdrop-filter: blur(4px) !important;
  box-shadow: 0 2px 10px rgba(0,0,0,0.6) !important;
  transition: all 0.15s ease;
   -webkit-app-region: no-drag;
}



#popoutVideoBtn:hover {
  transform: scale(1.1);
}

body:not(.video-only) #popoutVideoBtn {
  background: none !important;
  backdrop-filter: none !important;
  box-shadow: none !important;
}



body.video-only footer {
    position: fixed !important;
    bottom: 6px;
    right: 6px;
    z-index: 1000;
    display: flex;
    justify-content: center;
    padding: 9px 31px;
    border-radius: 6px;
    color: white;
    height: 32px !important;
    width: 61px !important;
    font-size: 20px;
    gap: 11px;
}

body.video-only footer > img {
    width: 40px !important;
    height: 23px !important;
}

body.video-only .controls,
body.video-only .volume-control
{
    position: fixed;
    top: 74%; 
    left: 50%; 
    transform: translateX(-50%);
    width: 237px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000 !important;
    pointer-events: auto;
    -webkit-app-region: no-drag;
    gap: 10px;
}


body.video-only .controls,
body.video-only .volume-control
{
    opacity: 0;                
    pointer-events: none;      
    transition: opacity 0.3s; 
    
}


body.video-only .controls .control-btn {
  border-radius: 25px;
  height: 39px;
}



body.video-only:hover .controls,
body.video-only:hover .volume-control{
    opacity: 1;              
    pointer-events: auto;   
}

body.video-only .volume-control > label{
    -webkit-app-region: no-drag;
    gap: 10px;
    background-color: rgba(33, 33, 33, 0.5);
    border-radius: 10px;
    padding: 0px 8px;
    width: 175px;
    height: 29px;
    backdrop-filter: blur(4px);
    top: 0vh;
    position: fixed; 
}

body.video-only #progressContainer {
    position: fixed;
    top: 0%;
    left: 50%;
    transform: translateX(-50%);
    width: 238px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000 !important;
    pointer-events: auto;
    -webkit-app-region: no-drag;
    gap: 10px;
    background-color: rgba(33, 33, 33, 0.5);
    border-radius: 34px;
    padding: 2px 18px;
    backdrop-filter: blur(4px);
    padding-bottom: 10px;  

}

body.video-only #videoSongName {
     position: absolute;
    top: 3vh;
    left: 50%;
    transform: translateX(-50%);
    color: white;
    font-size: 0.6em;
    font-weight: bold;
    text-shadow: 0 0 10px rgba(0,0,0,0.7);
    pointer-events: none;
    z-index: 20;
    text-align: center;
    white-space: nowrap;
}

#artworkLayer {
  position: absolute !important;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  z-index: 0 !important;
  pointer-events: none;
}


#container > #artworkLayer {
  z-index: 1 !important;
}







  </style>
</head>
<body>
  <div id="titlebar" 
     style="-webkit-app-region: drag; height: 99px; position: absolute; top: 0; left: 0; right: 0; z-index: 1; cursor: pointer;">
</div>
   
  </div>
  <div id="rainbow-helper"></div>
  <div id="container">
   
  <div id="topControls" style="width: 100%; justify-content: space-between;">
  <div style="display: flex; align-items: center; gap: 0px;">
    <button id="notifyToggleBtn" style="background: none; border: none; cursor: pointer;" title="Notifications">
      <img src="build/bell.svg" id="bellIcon" height="17" />
    </button>
    <button id="gifPreviewToggleBtn" style="background: none; border: none; cursor: pointer;" title="Canvas Mode">
  <img src="build/gif.svg" id="gifIcon" height="20" />  
</button>
    <div id="visualizerControls">
      <button id="visualizerToggleBtn" style="background: none; border: none; cursor: pointer;" title="Audio Visualizer">
        <img src="build/visualizer.svg" id="visualizerIcon" height="20" />
      </button>
      <input type="color" id="visualizerColor" value="#a88cff" title="Select Theme Color" />
      <button id="rainbowToggleBtn" style="background: none; border: none; cursor: pointer;" title="Neon Mode (Requires Visualizer)">
        <img id="rainbowIcon" src="build/flashoff.svg" height="27" />
      </button>
    </div>
    <button id="miniPlayerBtn" style="background: none; border: none; cursor: pointer; margin-left: 10px;" title="Mini Player">
      <img src="build/miniplayer.svg" height="20" />
    </button>

    
  </div>





  <button id="hamburgerBtn" style="background: none; border: none; cursor: pointer; padding: 8px; -webkit-app-region: no-drag;" title="Menu">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round">
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </button>
</div>




<div id="hamburgerMenu" style="position: absolute; top: 70px; right: 15px; background: #222; border-radius: 3px; box-shadow: 0 4px 20px rgba(0,0,0,0.6); border: 2px solid var(--primary-color); display: none; z-index: 9999; min-width: 200px; -webkit-app-region: no-drag;">
  <button id="downloadYoutubeBtn" style="width: 100%; padding: 14px 20px; background: none; border: none; color: white; text-align: left; font-size: 14px; cursor: pointer;">
    Download With Yt-Dlp
  </button>
  <button id="aboutBtn" style="width: 100%; padding: 14px 20px; background: none; border: none; color: white; text-align: left; font-size: 14px; cursor: pointer;">
    About NeonKat
  </button>

<div class="vis-mode-toggle" id="autoUpdateAppToggle">
  <span class="label">Auto-update app</span>
  <label class="switch">
    <input type="checkbox" id="autoUpdateAppCheckbox">
    <span class="slider"></span>
  </label>
</div>

<div class="vis-mode-toggle" id="lowPerfToggle">
  <span class="label">Low Performance UI</span>
  <label class="switch">
    <input type="checkbox" id="lowPerfCheckbox">
    <span class="slider"></span>
  </label>
</div>

 <div class="vis-mode-toggle" id="barsToggle">
  <span class="label">Visualizer Bars</span>
  <label class="switch">
    <input type="checkbox" id="barsCheckbox">
    <span class="slider"></span>
  </label>
</div>
<div class="vis-mode-toggle" id="bubblesToggle">
  <span class="label">Music Note Bubbles</span>
  <label class="switch">
    <input type="checkbox" id="bubblesCheckbox">
    <span class="slider"></span>
  </label>
</div>

<div class="vis-mode-toggle" id="katbubblesToggle">
  <span class="label">Kat Bubbles</span>
  <label class="switch">
    <input type="checkbox" id="katbubblesCheckbox">
    <span class="slider"></span>
  </label>
</div>

<div class="vis-mode-toggle" id="nukebubblesToggle">
  <span class="label">Nuke Bubbles</span>
  <label class="switch">
    <input type="checkbox" id="nukebubblesCheckbox">
    <span class="slider"></span>
  </label>
</div>

<div id="customBgToggle" style="padding: 14px 20px; display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
  <span class="label">Custom Background</span>
  <button id="custom-set-btn" style="
    padding: 8px 20px;
    background: #434242;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    pointer-events: auto;
    position: relative;
    z-index: 999;
  ">Set</button>
</div>
</div>

 


    <h1 style="display: flex; align-items: center; gap: 8px; ">
      NeonKat
      <img src="build/kat.png" style="height: 54px;" />
    </h1>
 <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
  <button id="chooseFolder" style="flex: 1;">Choose Folder</button>
  <button id="addStreamBtn" class="control-btn" style="flex: 1;">Radio Stream</button>
  <button id="connectJellyfinBtn" class="control-btn" style="flex: 1;">Jellyfin</button>
</div>

    <div id="streamModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; border-radius: 3px; background: rgba(0,0,0,0.8); border-radius: 3px; justify-content: center; align-items: center; z-index: 9999;">
  <div style="background: #111111; padding: 20px; border-radius: 3px; width: 90%; max-width: 400px; color: white;  border: 3px solid var(--primary-color);
    border-radius: 3px;-webkit-app-region: no-drag;">
    <h3 style="margin-top: 0; color: var(--primary-color);">Add Radio Stream</h3>
    <label>Stream URL (.mp3, .aac, .pls, .m3u etc.):</label>
    <input type="text" id="streamUrlInput" style="width: 100%; padding: 10px; margin: 10px 0; background: #111111; border: none; border-radius: 5px; color: white;" placeholder="https://example.com/stream.mp3" />
    
    <label>Station Name (optional):</label>
    <input type="text" id="streamNameInput" style="width: 100%; padding: 10px; margin: 10px 0; background: #111111; border: none; border-radius: 5px; color: white;" placeholder="My Favorite Station" />
    
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button id="cancelStreamBtn" style="background: #444; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Cancel</button>
      <button id="addStreamConfirmBtn" style="background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Add</button>
    </div>
  </div>
</div>


<div id="customBgModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); justify-content: center; align-items: center; z-index: 99999;">
  <div style="background: #111; padding: 25px; border-radius: 3px; width: 90%; max-width: 420px; border: 3px solid var(--primary-color); color: white; text-align: center;">
    <h3 style="margin-top: 0; color: var(--primary-color);">Set Custom Background</h3>
    <p style="margin: 10px 0 20px;">Paste an image URL or local file path <br><small>(leave empty to remove current bg ♡)</small></p>
    <input type="text" id="customBgInput" placeholder="https://... or file:///C:/.../cute.jpg" 
           style="width: 100%; padding: 12px; background: #222; border: none; border-radius: 6px; color: white; font-size: 14px; margin-bottom: 20px;">
    <div style="display: flex; gap: 15px; justify-content: center;">
      <button id="cancelBgBtn" style="padding: 10px 20px; background: #444; border: none; border-radius: 6px; color: white; cursor: pointer;">Cancel</button>
      <button id="applyBgBtn" style="padding: 10px 25px; background: var(--primary-color); color: black; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">Apply ♡</button>
    </div>
  </div>
</div>


<div id="jellyfinModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 9999;">
  <div style="background: #111111; padding: 20px; border-radius: 3px; width: 90%; max-width: 400px; color: white; border: 3px solid var(--primary-color);">
    <h3 style="margin-top: 0; color: var(--primary-color);">Connect to Jellyfin</h3>
    <label>Server URL:</label>
    <input type="text" id="jellyfinServerInput" style="width: 100%; padding: 10px; margin: 10px 0; background: #111111; border: none; border-radius: 5px; color: white;" placeholder="http://192.168.1.100:8096" />
    
    <label>Username:</label>
    <input type="text" id="jellyfinUserInput" style="width: 100%; padding: 10px; margin: 10px 0; background: #111111; border: none; border-radius: 5px; color: white;" />
    
    <label>Password:</label>
    <input type="password" id="jellyfinPassInput" style="width: 100%; padding: 10px; margin: 10px 0; background: #111111; border: none; border-radius: 5px; color: white;" />
<label>Search (optional):</label>
    <input type="text" id="jellyfinSearchInput" style="width: 100%; padding: 10px; margin: 10px 0; background: #111111; border: none; border-radius: 5px; color: white;" placeholder="e.g. EDM, Country, etc..." />
  <div style="display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
      <button id="cancelJellyfinBtn" style="background: #444; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Cancel</button>
      <button id="refreshJellyfinBtn" style="background: #212121; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; display: none;">Refresh Library</button>
      <button id="disconnectJellyfinBtn" style="background: #800000; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; display: none;">Disconnect</button>
      <button id="connectJellyfinConfirmBtn" style="background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Connect</button>
    </div>
         <div id="jellyfinStatus" style="font-size: 12px; color: var(--primary-color); text-align: center; margin-bottom: 10px; display: none;top: 26px;
    position: relative;">Disconnected</div>
  </div>
</div>
    <div class="sort-wrapper" style="position: relative;">
  <button id="sortBtn">Playlist Options</button>
    <div id="sortMenu" style="position: absolute; background: #222; border-radius: 8px; box-shadow: 0 0 12px rgba(0,0,0,0.8); z-index: 10; display: none; width: 260px; padding: 10px; border: 2px solid var(--primary-color); max-height: 400px; overflow-y: auto; right: 1px;">
  
  
  <div style="margin-bottom: 12px; position: relative;">
    <input 
      type="text" 
      id="playlistQuickSearch" 
      placeholder="Find song..." 
      style="width: 100%; padding: 10px 40px 10px 12px; background: #282828; border: none; border-radius: 6px; color: #fff; font-size: 13px; box-sizing: border-box;"
    />
    <button id="clearQuickSearch" 
      style="position: absolute; right: 10px; top: 0%; background: none; border: none; color: #777; font-size: 18px; cursor: pointer; display: none;">
      ×
    </button>
  </div>

 
  <div style="margin-bottom: 10px;">
    <button id="sortNameAsc" class="sort-btn">Name (A-Z)</button>
    <button id="sortNameDesc" class="sort-btn">Name (Z-A)</button>
    <button id="sortDateDesc" class="sort-btn">Date (Newest)</button>
    <button id="sortDateAsc" class="sort-btn">Date (Oldest)</button>
  </div>

  <hr style="border: none; border-top: 1px solid #444; margin: 8px 0;">

 
  <button id="closeSortMenuBtn" style="width: 100%; padding: 8px; background: #28282878; border: none; border-radius: 6px; color: white; cursor: pointer;">
    Close
  </button>
</div>
    </div>

    <div id="contextMenu" style="position: fixed; background: #1a1a1a; border: 1px solid #333; border-radius: 6px; padding: 6px 0; display: none; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.6);">
  <button id="removeTrackBtn" class="control-btn" style="width: 100%; padding: 8px 20px; background: none; border: none; color: #fff; text-align: left; cursor: pointer; font-size: 13px; height: auto; line-height: 1;">
  Remove from Playlist
</button>
</div>
    <ul id="playlist"></ul>
   
    <div class="controls" style="display: flex; gap: 10px; margin-bottom: 10px;">
      <button id="playPauseBtn" class="control-btn">
        <img id="playPauseIcon" src="build/play.svg" alt="Play/Pause" class="icon" />
      </button>
      <button id="prevBtn" class="control-btn">
        <img id="playPauseIcon" src="build/skip-back.svg" alt="SkipBack" class="icon" />
      </button>

         <button id="nextBtn" class="control-btn">
        <img id="playPauseIcon" src="build/skip-next.svg" alt="SkipNext" class="icon" />
      </button>
      <button id="repeatBtn" class="control-btn">
        <img src="build/repeat.svg" alt="Repeat" class="icon" />
      </button>
      <button id="shuffleBtn" class="control-btn">
        <img src="build/shuffle.svg" alt="Shuffle" class="icon" />
      </button>

    </div>
    <div id="playlistControls" style="display: flex; gap: 10px; margin-bottom: 10px;">
      <button id="savePlaylistBtn" class="control-btn">Save</button>
      <button id="loadPlaylistBtn" class="control-btn">Load</button>
      <button id="clearPlaylistBtn" class="control-btn">Clear</button>
    </div>
    <div class="volume-control" style="display: flex; align-items: center; gap: 5px;">
         <label for="volume">
        <img src="build/volume.svg" alt="Volume" width="20" height="20" > 
        <input type="range" id="volume" min="0" max="1" step="0.01" value="1" />
        <span id="volumePercent">100%</span>
      <div id="selectedFolderName"></div>
   
    </div>
    <div id="progressContainer">
        <div id="videoSongName"></div>
      <span id="currentTime">0:00</span>
      <input type="range" id="progressBar" value="0" min="0" step="0.1" />
      <span id="duration">0:00</span>
    
    </div>
   <div id="visualizerWrapper">
  <img id="visualizerBgGif">
  <video id="visualizerVideo"></video>
  <canvas id="visualizer"></canvas>
   <button id="popoutVideoBtn" style="background:none; border:none; cursor:pointer; margin-left:6px;" title="Pop out video only">
  <img src="build/pop-out.svg" height="12" alt="Popout" style="filter: invert(1);" />
</button>
   <img id="artLoader" style="display:none; position:absolute; left:-9999px;" crossorigin="anonymous">
</div>
    <footer>
  <img src="build/kat.png" alt=':)' style="    width: 15px;
    height: 15px;
    margin-right: 8px;
    vertical-align: middle;
    -webkit-app-region: drag;
    transform: scale(2) !important; -webkit-app-region: drag;">
  NeonKat
</footer>
  </div>
  <audio id="audio"></audio>
  <style>
label img {
  filter: brightness(0) invert(1);
  top: 7px;
  position: relative;
}

</style>
<script>
  const bubbleImages = [
  new Image(),
  new Image()
];
  bubbleImages[0].src = 'build/note.png'; 
  bubbleImages[1].src = 'build/note1.png'; 
  
 const katbubbleImages = [
  new Image()
];

 const nukebubbleImages = [
  new Image()
];
nukebubbleImages[0].src = 'build/nuke.png';
katbubbleImages[0].src = 'build/kat.png';
  const filePickerBtn = document.getElementById('chooseFolder');
  const savePlaylistBtn = document.getElementById('savePlaylistBtn');
  const loadPlaylistBtn = document.getElementById('loadPlaylistBtn');
  const selectedFolderName = document.getElementById('selectedFolderName');
  let visualizerMode = localStorage.getItem('visualizerMode') || 'bars';
  const barsToggle = document.getElementById('barsToggle');
  const bubblesToggle = document.getElementById('bubblesToggle');
  const katbubblesToggle = document.getElementById('katbubblesToggle');
  const nukebubblesToggle = document.getElementById('nukebubblesToggle');
  const barsCheckbox = document.getElementById('barsCheckbox');
  const bubblesCheckbox = document.getElementById('bubblesCheckbox');
  let skipVideo = localStorage.getItem('skipVideo') === 'true';
  const playlistElem = document.getElementById('playlist');
  const audio = document.getElementById('audio');
  const visualizerCanvas = document.getElementById('visualizer');
  const ctx = visualizerCanvas.getContext('2d');
  const volumeSlider = document.getElementById('volume');
  const progressBar = document.getElementById('progressBar');
  const currentTimeElem = document.getElementById('currentTime');
  const durationElem = document.getElementById('duration');
  const sortBtn = document.getElementById('sortBtn');
  const sortMenu = document.getElementById('sortMenu');
 
  let audioFiles = [];
  let rainbowIntervalId = null;
  let currentIndex = 0;
  let flashIntensity = 0; 
  let isSeeking = false;
  let repeatTrack = false;
  let shuffleTrack = false;
  let notifyEnabled = localStorage.getItem('notifyEnabled') === 'true';
  let visualizerToggle = localStorage.getItem('visualizerToggle') === 'true';
  let animationFrameId = null;
  let themeColor = localStorage.getItem('themeColor') || '#a88cff';
  let isRainbowActive = localStorage.getItem('isRainbowActive') === 'true';
  const rainbowIcon = document.getElementById('rainbowIcon');
  rainbowIcon.src = isRainbowActive ? 'build/flash.svg' : 'build/flashoff.svg';
  const rainbowToggleBtn = document.getElementById('rainbowToggleBtn');
  const barsToggleBtn = document.getElementById('barsToggleBtn');
  const bubblesToggleBtn = document.getElementById('bubblesToggleBtn');
  const katbubblesToggleBtn = document.getElementById('katbubblesToggleBtn');
  const nukebubblesToggleBtn = document.getElementById('nukebubblesToggleBtn');
  let rainbowFrameId = null;
  let currentArtImage = null;
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const analyser = audioCtx.createAnalyser();
  let currentSearchTerm = '';
  analyser.fftSize = 128;
  const source = audioCtx.createMediaElementSource(audio);
  source.connect(analyser);
  const lowpass = audioCtx.createBiquadFilter();
  lowpass.type = 'lowpass';
  lowpass.frequency.value = 150;  
  lowpass.Q.value = 1;           
  source.connect(lowpass);
  lowpass.connect(analyser);
  analyser.connect(audioCtx.destination); 
  analyser.connect(audioCtx.destination);
  const radioIconImg = new Image();
  radioIconImg.src = 'build/radio.svg';

  let src;
  let displayName;


  const repeatBtn = document.getElementById('repeatBtn');
  const shuffleBtn = document.getElementById('shuffleBtn');
  const visualizerColorPicker = document.getElementById('visualizerColor');
  const miniplayerToggleBtn = document.getElementById('miniplayerToggleBtn');
    const miniBtn = document.getElementById('miniPlayerBtn');
    let isMini = false;


   let jellyfinConfig = {
  server: localStorage.getItem('jellyfinServer') || '',
  token: localStorage.getItem('jellyfinToken') || '',
  userId: localStorage.getItem('jellyfinUserId') || '',
  deviceId: 'neonkat-' + Math.random().toString(36).substring(7)
};

const jellyfinStatus = document.getElementById('jellyfinStatus');
if (jellyfinConfig.token) {
  jellyfinStatus.style.display = 'block';
  jellyfinStatus.textContent = 'Connected to Jellyfin';
} else {
  jellyfinStatus.style.display = 'none';
}

updateJellyfinModalButtons();
const artworkDurationSelect = document.getElementById('artworkDurationSelect');
const customArtworkInput = document.getElementById('customArtworkSeconds');

let selectedDuration = 30;

function updateArtworkDuration() {
    const val = artworkDurationSelect.value;
    
    if (val === 'custom') {
        customArtworkInput.style.display = 'inline-block';
        customArtworkInput.focus();
        let sec = parseInt(customArtworkInput.value, 10);
        selectedDuration = (isNaN(sec) || sec < 5) ? 30 : Math.min(sec, 600);
    } else {
        customArtworkInput.style.display = 'none';
        selectedDuration = (val === 'full') ? Infinity : Number(val);
    }
}



const customBgToggle = document.getElementById('customBgToggle');
const customBgModal = document.getElementById('customBgModal');
const customBgInput = document.getElementById('customBgInput');
const applyBgBtn = document.getElementById('applyBgBtn');
const cancelBgBtn = document.getElementById('cancelBgBtn');
const container = document.getElementById('container');

function applyCustomBackground(url = null) {
    const container = document.getElementById('container');

    if (!url || url.trim() === '') {
        container.style.backgroundImage = 'none';
        container.style.backgroundColor = '#111';
        container.classList.remove('custom-bg');          
        localStorage.removeItem('customBackgroundUrl');
        return;
    }

    const img = new Image();
    img.onload = () => {
        container.style.backgroundImage = `url("${url}")`;
        container.style.backgroundSize = 'contain';
        container.style.backgroundPosition = 'center';
        container.style.backgroundRepeat = 'no-repeat';
        container.classList.add('custom-bg');            
        localStorage.setItem('customBackgroundUrl', url);
        if (notifyEnabled && Notification.permission === 'granted') {
        window.electronAPI.notify('Background set! ♡(>ᴗ<)♡');
        }
        else{
        alert("Background set! ♡(>ᴗ<)♡");
        }
    };
    img.onerror = () => {
      if (notifyEnabled && Notification.permission === 'granted') {
        window.electronAPI.notify("Oopsie! Couldn't load that image... (´；ω；`) Check the URL please");
        }
        else{
        alert("Oopsie! Couldn't load that image... (´；ω；`) Check the URL please");
        }
    };
    img.src = url;
}


const saved = localStorage.getItem('autoUpdateEnabled');
const isEnabled = saved === 'true'; 

if (window.electronAPI && window.electronAPI.sendAutoUpdateState) {
  window.electronAPI.sendAutoUpdateState(isEnabled);
}

const savedCustomBg = localStorage.getItem('customBackgroundUrl');
if (savedCustomBg) {
    const container = document.getElementById('container');
    container.style.backgroundImage = `url("${savedCustomBg}")`;
    container.style.backgroundSize = 'contain';
    
    container.style.backgroundPosition = 'center';
    container.style.backgroundRepeat = 'no-repeat';
    container.classList.add('custom-bg');
}


customBgToggle.addEventListener('click', () => {
    customBgInput.value = localStorage.getItem('customBackgroundUrl') || '';
    customBgModal.style.display = 'flex';
    customBgInput.focus();
});

audio.addEventListener('play',   () => visualizerVideo.play().catch(e=>0));
audio.addEventListener('pause',  () => visualizerVideo.pause());
audio.addEventListener('seeking',() => {
  if (visualizerVideo.src) {
    visualizerVideo.currentTime = audio.currentTime % (visualizerVideo.duration || 1) || 0;
  }
});

audio.addEventListener('timeupdate', () => {
  if (!visualizerVideo.src || visualizerVideo.paused) return;
  const diff = Math.abs(visualizerVideo.currentTime - (audio.currentTime % visualizerVideo.duration));
  if (diff > 0.4) {
    visualizerVideo.currentTime = audio.currentTime % visualizerVideo.duration;
  }
});

applyBgBtn.addEventListener('click', () => {
    const url = customBgInput.value.trim();
    applyCustomBackground(url);
    customBgModal.style.display = 'none';
});


cancelBgBtn.addEventListener('click', () => {
    customBgModal.style.display = 'none';
});


customBgModal.addEventListener('click', (e) => {
    if (e.target === customBgModal) customBgModal.style.display = 'none';
});


let lowPerfMode = localStorage.getItem('lowPerfMode') === 'true';

const lowPerfCheckbox = document.getElementById('lowPerfCheckbox');
const lowPerfRow = document.getElementById('lowPerfToggle');


if (lowPerfCheckbox) {
  lowPerfCheckbox.checked = lowPerfMode;
}

applyLowPerfMode();
function applyLowPerfMode() {
  if (lowPerfMode) {
    document.body.classList.add('low-perf');
    localStorage.setItem('lowPerfMode', 'true');
  } else {
    document.body.classList.remove('low-perf');
    localStorage.setItem('lowPerfMode', 'false');
  }
  renderPlaylist();
}


if (lowPerfRow) {
  lowPerfRow.addEventListener('click', (e) => {
    if (e.target.closest('.switch, input[type="checkbox"]')) return;

    lowPerfMode = !lowPerfMode;
    if (lowPerfCheckbox) lowPerfCheckbox.checked = lowPerfMode;
    applyLowPerfMode();

    if (notifyEnabled && Notification.permission === 'granted') {
      window.electronAPI.notify(
        lowPerfMode ? "Low Performance UI ON ♡" : "Low Performance UI OFF"
      );
    }
  });
}

if (lowPerfCheckbox) {
  lowPerfCheckbox.addEventListener('change', () => {
    lowPerfMode = lowPerfCheckbox.checked;
    applyLowPerfMode();
  });
}
function quickSearchPlaylist() {
  const input = document.getElementById('playlistQuickSearch');
  const clearBtn = document.getElementById('clearQuickSearch');
  
  currentSearchTerm = input.value.toLowerCase().trim();
  clearBtn.style.display = currentSearchTerm ? 'block' : 'none';

  renderPlaylist();
}


document.getElementById('prevBtn').addEventListener('click', () => {
  if (currentIndex > 0) {
    currentIndex--;
    playTrack(currentIndex);
  } else {
    currentIndex = audioFiles.length - 1;
    playTrack(currentIndex);
  }
});


document.getElementById('nextBtn').addEventListener('click', () => {
  if (currentIndex < audioFiles.length - 1) {
    currentIndex++;
    playTrack(currentIndex);
  } else {
    currentIndex = 0;
    playTrack(currentIndex);
  }
});


document.getElementById('playlistQuickSearch').addEventListener('input', quickSearchPlaylist);


document.getElementById('clearQuickSearch').addEventListener('click', () => {
  const input = document.getElementById('playlistQuickSearch');
  input.value = '';
  currentSearchTerm = '';
  document.getElementById('clearQuickSearch').style.display = 'none';
  renderPlaylist();
  scrollToCurrentTrack();
});


document.getElementById('closeSortMenuBtn').addEventListener('click', () => {
    document.getElementById('sortMenu').style.display = 'none';
});


document.getElementById('playlistQuickSearch').addEventListener('click', e => e.stopPropagation());

document.getElementById('playlistQuickSearch').addEventListener('keydown', (e) => {
 if (e.key === 'Enter') {
    e.preventDefault();
    const input = e.target;
    const clearBtn = document.getElementById('clearQuickSearch');
    input.value = '';
    clearBtn.style.display = 'none';
    input.blur();
    document.getElementById('sortMenu').style.display = 'none';
  }
});

const connectJellyfinBtn = document.getElementById('connectJellyfinBtn');
const jellyfinModal = document.getElementById('jellyfinModal');
const serverInput = document.getElementById('jellyfinServerInput');
const userInput = document.getElementById('jellyfinUserInput');
const passInput = document.getElementById('jellyfinPassInput');
const cancelBtn = document.getElementById('cancelJellyfinBtn');
const confirmBtn = document.getElementById('connectJellyfinConfirmBtn');

connectJellyfinBtn.addEventListener('click', () => {
  serverInput.value = jellyfinConfig.server;
  jellyfinModal.style.display = 'flex';
});

cancelBtn.addEventListener('click', () => jellyfinModal.style.display = 'none');
jellyfinModal.addEventListener('click', (e) => { if (e.target === jellyfinModal) jellyfinModal.style.display = 'none'; });

confirmBtn.addEventListener('click', async () => {
  const server = serverInput.value.trim().replace(/\/$/, '');
  const username = userInput.value.trim();
  const password = passInput.value;
  if (notifyEnabled && Notification.permission === 'granted') {
    window.electronAPI.notify('Connecting To Jellyfin Server');
  }
  else{alert('Connecting To Jellyfin Server');}
  if (!server || !username || !password) {
    alert('Fill in all the fucking fields!');
    return;
  }

  try {
    const authResponse = await fetch(`${server}/Users/AuthenticateByName`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-Emby-Authorization': `MediaBrowser Client="NeonKat", Device="Desktop", DeviceId="${jellyfinConfig.deviceId}", Version="0.1.6 alpha"` },
      body: JSON.stringify({ Username: username, Pw: password })
    });

    if (!authResponse.ok) throw new Error('Auth failed – wrong creds?');

    const authData = await authResponse.json();
    jellyfinConfig = {
      server,
      token: authData.AccessToken,
      userId: authData.User.Id,
      deviceId: jellyfinConfig.deviceId
    };

    localStorage.setItem('jellyfinServer', server);
    localStorage.setItem('jellyfinToken', jellyfinConfig.token);
    localStorage.setItem('jellyfinUserId', jellyfinConfig.userId);
    jellyfinStatus.style.display = 'block';
    jellyfinStatus.textContent = `Connected as ${authData.User.Name}`;
    await loadJellyfinLibrary();
    updateJellyfinModalButtons();
  } catch (err) {
    alert(`Connection fucked up: ${err.message}`);
  }
});



async function loadJellyfinLibrary() {
  if (!jellyfinConfig.token) return;

  try {
    const viewsRes = await fetch(`${jellyfinConfig.server}/Users/${jellyfinConfig.userId}/Views?api_key=${jellyfinConfig.token}`);
    if (!viewsRes.ok) throw new Error(`Views fetch failed: ${viewsRes.status}`);
    const views = await viewsRes.json();
    const musicView = views.Items.find(v => v.CollectionType === 'music' || v.Name.toLowerCase().includes('music'));
    if (!musicView) throw new Error('No music library found – check your Jellyfin setup');

    const fields = 'Name,Artists,AlbumArtists,ArtistItems,Album,AlbumPrimaryImageTag,ImageTags,MediaSources,Container,Path,ProductionLocations,SortName';
    const searchInput = document.getElementById('jellyfinSearchInput');
    const searchTerm = searchInput ? searchInput.value.trim() : '';

    let itemsUrl = `${jellyfinConfig.server}/Items?IncludeItemTypes=Audio&Recursive=true&Fields=${fields}&Limit=3000&SortBy=SortName&api_key=${jellyfinConfig.token}`;
    let statusMsg = 'Loading all tracks...';

    if (searchTerm) {
      try {
  const lowerSearch = searchTerm.toLowerCase();
  const genresRes = await fetch(`${jellyfinConfig.server}/MusicGenres?searchTerm=${encodeURIComponent(lowerSearch)}&api_key=${jellyfinConfig.token}`);
  const genresData = await genresRes.json();
  let foundGenres = genresData.Items || [];
  if (foundGenres.length === 0) {
    const exactRes = await fetch(`${jellyfinConfig.server}/MusicGenres?nameStartsWith=${encodeURIComponent(searchTerm)}&api_key=${jellyfinConfig.token}`);
    const exactData = await exactRes.json();
    foundGenres = exactData.Items || [];
  }
  
  if (foundGenres.length > 0) {
    const genreIds = foundGenres.map(item => item.Id).join(',');
    itemsUrl += `&GenreIds=${genreIds}&ParentId=${musicView.Id}`;
    statusMsg = `Loading ${foundGenres.length} genres matching "${searchTerm}"`;
  } else {
    itemsUrl += `&SearchTerm=${encodeURIComponent(searchTerm)}&ParentId=${musicView.Id}`;
    statusMsg = `No genre found – searching titles/artists for: ${searchTerm}`;
  }
} catch (genreErr) {
  console.warn('Genre fuckup, full fallback:', genreErr);
  itemsUrl += `&SearchTerm=${encodeURIComponent(searchTerm)}&ParentId=${musicView.Id}`;
}
    } else {
      itemsUrl += `&ParentId=${musicView.Id}`;
    }

    jellyfinStatus.textContent = statusMsg;
    const itemsRes = await fetch(itemsUrl);
    if (!itemsRes.ok) throw new Error(`Tracks fetch failed: ${itemsRes.status}`);
    const data = await itemsRes.json();

    audioFiles = [];

    for (const item of data.Items) {
      if (!item.MediaSources || item.MediaSources.length === 0) continue;

      const mediaSource = item.MediaSources[0];
      const container = mediaSource.Container || 'mp3';

      const streamParams = new URLSearchParams({
        api_key: jellyfinConfig.token,
        UserId: jellyfinConfig.userId,
        DeviceId: jellyfinConfig.deviceId,
        static: 'true',
        Container: container,
        AudioCodec: mediaSource.AudioCodec || '',
        PlaySessionId: 'neonkat-' + Date.now()
      });

      const streamUrl = `${jellyfinConfig.server}/Audio/${item.Id}/stream?${streamParams}`;
      let fullName = item.Name || 'Unknown Track';
      let artists = 'Unknown Artist';
      let title = fullName.trim();

      const firstDashMatch = fullName.match(/[-–—]\s*/);
      if (firstDashMatch) {
        const dashIndex = firstDashMatch.index;
        const dashLength = firstDashMatch[0].length;
        artists = fullName.substring(0, dashIndex).trim();
        title = fullName.substring(dashIndex + dashLength).trim();
      } else if (item.Path) {
        const filename = item.Path.split(/[\\/]/).pop().replace(/\.[^.]+$/, '').trim();
        const filenameMatch = filename.match(/[-–—]\s*/);
        if (filenameMatch) {
          const dashIndex = filenameMatch.index;
          const dashLength = filenameMatch[0].length;
          artists = filename.substring(0, dashIndex).trim();
          title = filename.substring(dashIndex + dashLength).trim();
        } else {
          title = filename;
        }
      }

      title = title
        .replace(/\s*\(Audio\)$/i, '')
        .replace(/\s*\(Music Video\).*?$/i, '')
        .replace(/\s*-\s*YouTube$/i, '')
        .replace(/\s*_\s*@[^@]+$/i, '')
        .replace(/^["']|["']$/g, '')
        .trim();

      if (artists.startsWith('-') || artists === '') {
        artists = 'Unknown Artist';
      }

      const displayName = `${artists} - ${title}`;
      let albumArt = 'build/default-artwork.jpg';
      if (item.AlbumPrimaryImageTag) {
        albumArt = `${jellyfinConfig.server}/Items/${item.AlbumId || item.Id}/Images/Primary?tag=${item.AlbumPrimaryImageTag}&api_key=${jellyfinConfig.token}`;
      } else if (item.ImageTags && item.ImageTags.Primary) {
        albumArt = `${jellyfinConfig.server}/Items/${item.Id}/Images/Primary?api_key=${jellyfinConfig.token}`;
      }

      audioFiles.push({
        url: streamUrl,
        name: displayName,
        isJellyfin: true,
        itemId: item.Id,
        albumArt: albumArt
      });
    }

    jellyfinStatus.textContent = `Connected – Loaded ${audioFiles.length} tracks`;
    const input = document.getElementById('playlistQuickSearch');
    input.value = '';
    currentSearchTerm = '';
    document.getElementById('clearQuickSearch').style.display = 'none';
    savedSortedOrder = [];
    isShuffled = false;
    shuffleBtn.classList.remove('enabled');

    currentIndex = 0;
    renderPlaylist();
    if (audioFiles.length > 0) {
      currentIndex = 0;
      playTrack(0);
    }
  } catch (err) {
    console.error(err);
    alert(`Load fucked up: ${err.message}`);
    jellyfinStatus.textContent = 'Connected (load error)';
  }
}


function updateJellyfinModalButtons() {
  const connected = !!jellyfinConfig.token;
  document.getElementById('connectJellyfinConfirmBtn').style.display = connected ? 'none' : 'block';
  document.getElementById('refreshJellyfinBtn').style.display = connected ? 'block' : 'none';
  document.getElementById('disconnectJellyfinBtn').style.display = connected ? 'block' : 'none';
  document.getElementById('jellyfinServerInput').disabled = connected;
  document.getElementById('jellyfinUserInput').disabled = connected;
  document.getElementById('jellyfinPassInput').disabled = connected;
}


connectJellyfinBtn.addEventListener('click', () => {
  serverInput.value = jellyfinConfig.server;
  userInput.value = '';
  passInput.value = '';
  jellyfinModal.style.display = 'flex';
  updateJellyfinModalButtons();
});

document.getElementById('refreshJellyfinBtn').addEventListener('click', async () => {
  if (!jellyfinConfig.token) return;
  jellyfinStatus.textContent = 'Refreshing...';
  await loadJellyfinLibrary();
});


document.getElementById('disconnectJellyfinBtn').addEventListener('click', () => {
  localStorage.removeItem('jellyfinServer');
  localStorage.removeItem('jellyfinToken');
  localStorage.removeItem('jellyfinUserId');
  jellyfinConfig = { server: '', token: '', userId: '', deviceId: jellyfinConfig.deviceId };
  jellyfinStatus.style.display = 'none';
  audioFiles = audioFiles.filter(item => typeof item === 'string' || item.isStream);
  renderPlaylist();
  jellyfinModal.style.display = 'none';
  audioFiles = [];
  currentIndex = 0;
  audio.pause();
  audio.src = '';
  visualizerCanvas.style.backgroundImage = 'none';
  visualizerCanvas.style.backgroundColor = '#111111';
  renderPlaylist();
  stopVideo();
  clearBackground();
  window.electronAPI.updateTrack({ songName: 'No Track', artUrl: null, isPlaying: false });
  alert('Disconnected from Jellyfin');
  updateJellyfinModalButtons();
});


function updateVisualizerModeUI() {
  barsToggle.classList.remove('active');
  bubblesToggle.classList.remove('active');
  katbubblesToggle.classList.remove('active');
  nukebubblesToggle.classList.remove('active');


  barsCheckbox.checked = false;
  bubblesCheckbox.checked = false;
  katbubblesCheckbox.checked = false;
  nukebubblesCheckbox.checked = false;


  if (visualizerMode === 'bars') {
    barsToggle.classList.add('active');
    barsCheckbox.checked = true;
  } else if (visualizerMode === 'bubbles') {
    bubblesToggle.classList.add('active');
    bubblesCheckbox.checked = true;
  } else if (visualizerMode === 'katbubbles') {
    katbubblesToggle.classList.add('active');
    katbubblesCheckbox.checked = true;
  } else if (visualizerMode === 'nukebubbles') {
    nukebubblesToggle.classList.add('active');
    nukebubblesCheckbox.checked = true;
  }
}


barsToggle.addEventListener('click', () => {
  visualizerMode = 'bars';
  localStorage.setItem('visualizerMode', visualizerMode);
  updateVisualizerModeUI();
  if (visualizerToggle && !audio.paused) visualize();
});

bubblesToggle.addEventListener('click', () => {
  visualizerMode = 'bubbles';
  localStorage.setItem('visualizerMode', visualizerMode);
  updateVisualizerModeUI();
  if (visualizerToggle && !audio.paused) visualize();
});


katbubblesToggle.addEventListener('click', () => {
  visualizerMode = 'katbubbles';
  localStorage.setItem('visualizerMode', visualizerMode);
  updateVisualizerModeUI();
  if (visualizerToggle && !audio.paused) visualize();
});

nukebubblesToggle.addEventListener('click', () => {
  visualizerMode = 'nukebubbles';
  localStorage.setItem('visualizerMode', visualizerMode);
  updateVisualizerModeUI();
  if (visualizerToggle && !audio.paused) visualize();
});


updateVisualizerModeUI();

const hamburgerBtn = document.getElementById('hamburgerBtn');
const hamburgerMenu = document.getElementById('hamburgerMenu');
const downloadYoutubeBtn = document.getElementById('downloadYoutubeBtn');

let menuOpen = false;

hamburgerBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  menuOpen = !menuOpen;
  hamburgerMenu.style.display = menuOpen ? 'block' : 'none';
});


document.addEventListener('click', () => {
  if (menuOpen) {
    menuOpen = false;
    hamburgerMenu.style.display = 'none';
  }
});


hamburgerMenu.addEventListener('click', (e) => {
  e.stopPropagation();
});

downloadYoutubeBtn.addEventListener('click', () => {
  hamburgerMenu.style.display = 'none';
  menuOpen = false;

  if (document.getElementById('ytModal')) {
    document.getElementById('ytModal').style.display = 'flex';
    return;
  }



 const modalHTML = `
<div id="ytModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 99999;">
  <div style="background: #111; padding: 25px; border-radius: 12px; width: 90%; max-width: 420px; border: 3px solid var(--primary-color);">
    <h3 style="margin-top: 0; color: var(--primary-color); text-align: center;">Download With Yt-Dlp</h3>

    <div style="background: #330000; border: 1px solid #ff3333; padding: 12px; border-radius: 8px; margin: 15px 0 20px 0; font-size: 13px; color: #ffaaaa; text-align: center;">
      <strong>⚠️ HEADS UP ⚠️</strong><br><br>
      Downloading large playlists (50+ videos) at once can get your IP temporarily rate-limited by YouTube for up to 24 hours.<br>
      So i have disabled playlist downloads :(
    </div>

    <input type="text" id="ytUrlInput" placeholder="Paste YouTube / Soundcloud URL here..." style="width: 100%; padding: 12px; background: #222; border: none; border-radius: 6px; color: white; margin-bottom: 10px; font-size: 14px;" />

    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
      <button id="chooseDlFolderBtn" style="padding: 10px 15px; background: #212121; border: none; border-radius: 6px; color: white; cursor: pointer; flex: 1;">Choose Folder</button>
      <span id="selectedDlFolder" style="color: var(--primary-color); font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 2;">No folder selected</span>
    </div>

    <div style="margin-bottom: 15px;">
  <select id="videoQualitySelect" style="width: 100%; padding: 10px; background: #222; color: white; border: 1px solid #444; border-radius: 6px; font-size: 14px;">
  <option value="bestvideo+bestaudio/best">Best quality (highest available)</option>
  <option value="bestvideo[height<=1080]+bestaudio/best">1080p</option>
  <option value="bestvideo[height<=720]+bestaudio/best">720p</option>
  <option value="bestvideo[height<=480]+bestaudio/best" selected>480p (recommended)</option>
</select>
    </div>

    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
      <span style="color: white; font-size: 14px;">Audio only (skip gif preview)</span>
      <div id="skipVideoToggle" style="width: 40px; height: 20px; background: #444; border-radius: 10px; position: relative; cursor: pointer;">
        <div id="skipVideoThumb" style="width: 18px; height: 18px; background: #444; border-radius: 50%; position: absolute; top: 1px; left: 1px; transition: left 0.2s;"></div>
      </div>
    </div>
<div style="display: flex; align-items: center; gap: 12px; margin: 8px 0; flex-wrap: wrap;">
  <label style="color: #ccc; font-size: 13px;">Gif preview length:</label>
  
  <select id="exportDurationSelect" style="
    background: #222;
    color: white;
    border: 1px solid #444;
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 13px;
  ">
    <option value="full">Full song</option>
    <option value="15">15 seconds</option>
    <option value="30" selected>30 seconds</option>
    <option value="60">60 seconds</option>
    <option value="90">90 seconds</option>
    <option value="custom">Custom...</option>
  </select>
  <input type="number" id="customExportSeconds"
         placeholder="seconds"
         min="5" max="600"
         style="display:none; width: 90px; background:#222; color:white; border:1px solid #444; border-radius:6px; padding:6px; font-size:13px;" />
</div>

    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button id="cancelYtBtn" style="padding: 10px 20px; background: #444; border: none; border-radius: 6px; color: white; cursor: pointer;">Cancel</button>
      <button id="downloadYtConfirmBtn" style="padding: 10px 20px; background: var(--primary-color); border: none; border-radius: 6px; color: black; cursor: pointer; font-weight: bold;">Download</button>
    </div>
    
  </div>
</div>`;





  document.body.insertAdjacentHTML('beforeend', modalHTML);
   const skipToggle = document.getElementById('skipVideoToggle');
  const skipThumb = document.getElementById('skipVideoThumb');
  const ytModal = document.getElementById('ytModal');
  const ytUrlInput = document.getElementById('ytUrlInput');
  const cancelBtn = document.getElementById('cancelYtBtn');
  const confirmBtn = document.getElementById('downloadYtConfirmBtn');
  const chooseFolderBtn = document.getElementById('chooseDlFolderBtn');
  const selectedFolderSpan = document.getElementById('selectedDlFolder');

  const artworkDurationSelect = document.getElementById('exportDurationSelect');
  const customExportInput   = document.getElementById('customExportSeconds');

  let selectedQuality = 'bestvideo[height<=480]+bestaudio/best[height<=480]';

const qualitySelect = document.getElementById('videoQualitySelect');

if (qualitySelect) {
  qualitySelect.addEventListener('change', () => {
    const val = qualitySelect.value;
    selectedQuality = val;
  });
  selectedQuality = qualitySelect.value || selectedQuality;
}

  let selectedDuration = 30;

  if (artworkDurationSelect) {
    artworkDurationSelect.addEventListener('change', () => {
      
      const val = artworkDurationSelect.value;
      if (val === 'custom') {
        customExportInput.style.display = 'inline-block';
        let sec = parseInt(customExportInput.value) || 30;
        selectedDuration = Math.max(5, Math.min(600, sec));
      } else {
        customExportInput.style.display = 'none';
        selectedDuration = val === 'full' ? Infinity : Number(val);
      }
    });
  }

  if (customExportInput) {
    customExportInput.addEventListener('input', () => {
      let sec = parseInt(customExportInput.value) || 30;
      selectedDuration = Math.max(5, Math.min(600, sec));
    });
  }


  let downloadFolder = null; 

function updateToggleUI() {
    if (skipVideo) {
        skipThumb.style.left = '21px';
        skipToggle.style.background = 'var(--primary-color)'; 
    } else {
        skipThumb.style.left = '1px';
        skipToggle.style.background = '#333'; 
    }
}

updateToggleUI();

  ytUrlInput.focus();
  chooseFolderBtn.addEventListener('click', async () => {
    const result = await window.electronAPI.pickDownloadFolder();
    if (result.success) {
      downloadFolder = result.folderPath;
      selectedFolderSpan.textContent = downloadFolder;
    } else {
      selectedFolderSpan.textContent = 'Canceled';
    }
  });

  cancelBtn.addEventListener('click', () => ytModal.remove());
  ytModal.addEventListener('click', (e) => { if (e.target === ytModal) ytModal.remove(); });


   
skipToggle.addEventListener('click', () => {
    skipVideo = !skipVideo;
    localStorage.setItem('skipVideo', skipVideo);
    updateToggleUI();
});
  confirmBtn.addEventListener('click', async () => {
  const url = ytUrlInput.value.trim();
  if (!url) {
    alert('Paste a fucking URL first!');
    return;
  }

  if (!downloadFolder) {
    alert('Pick a folder first!');
    return;
  }

  const qualityFormat = document.getElementById('videoQualitySelect').value;

  confirmBtn.textContent = 'Downloading...';
  confirmBtn.disabled = true;
  let skipVideo = localStorage.getItem('skipVideo') === 'true';
  try {
    const result = await window.electronAPI.downloadYoutube({
      url,
      downloadFolder,
      skipVideo: skipVideo,
      format: qualityFormat,
      artworkDuration: selectedDuration
    });

    if (result.success) {
      renderPlaylist();
      if (Notification.permission === 'granted') {
        window.electronAPI.notify('Download Complete :)');
      } else {
        alert('Download complete :)');
      }
    } else {
      alert(`Download failed: ${result.message || 'Unknown error'}`);
    }
  } catch (err) {
    alert('Something went wrong: ' + err.message);
  }

  confirmBtn.textContent = 'Download';
  confirmBtn.disabled = false;
});
})


const aboutBtn = document.getElementById('aboutBtn');
aboutBtn.addEventListener('click', () => {
  hamburgerMenu.style.display = 'none';
  menuOpen = false;
  let aboutModal = document.getElementById('aboutModal');
  if (aboutModal) {
    aboutModal.style.display = 'flex';
    return;
  }

  aboutModal = document.createElement('div');
  aboutModal.id = 'aboutModal';
  aboutModal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 99999;';
  aboutModal.innerHTML = `
    <div style="background: #111; padding: 30px; border-radius: 12px; width: 90%; max-width: 400px; border: 3px solid var(--primary-color); text-align: center; color: white;">
      <h3 style="margin-top: 0; color: var(--primary-color);">About NeonKat</h3>
      <p style="font-size: 16px; margin: 15px 0;">Made With ❤️ By <strong>PaleCache</strong></p>
      <p style="font-size: 14px; margin-bottom: 20px;">A music player with yt-dlp support, streams, and neon vibes. Check out the source and star it if you love it!</p>
      <button id="openGitHubBtn" style="padding: 10px 20px; background: var(--primary-color); border: none; border-radius: 6px; color: black; cursor: pointer; font-weight: bold; margin-bottom: 15px;">Source Code ♡</button>
      <button id="closeAboutBtn" style="padding: 10px 20px; background: #444; border: none; border-radius: 6px; color: white; cursor: pointer;">Close</button>
       <p style="font-size: 14px;margin: 15px 0; right: 10px; position: fixed;"></strong>📦 V0.2.6 alpha</p>
      </div>
  </div>
  `;

  document.body.appendChild(aboutModal);
  const closeBtn = document.getElementById('closeAboutBtn');
  const gitHubBtn = document.getElementById('openGitHubBtn');
  gitHubBtn.addEventListener('click', async () => {
    await window.electronAPI.openExternal('https://github.com/PaleCache/NeonKat');
  });
  closeBtn.addEventListener('click', () => aboutModal.remove());
  aboutModal.addEventListener('click', (e) => {
    if (e.target === aboutModal) aboutModal.remove();
  });
});

    miniBtn.addEventListener('click', () => {
      isMini = !isMini;
      document.body.classList.toggle('mini-mode', isMini);
      window.electronAPI.setMiniMode(isMini);
      setTimeout(visualize, 100);
    });
  function updateSliderBackground(slider) {
    const value = (slider.value - slider.min) / (slider.max - slider.min) * 100;
    slider.style.background = `linear-gradient(to right, var(--primary-color) 0%, var(--primary-color) ${value}%, #444 ${value}%, #444 100%)`;
  }

  function updateThemeColor(color, isRainbow = isRainbowActive) {
    themeColor = color;
    isRainbowActive = isRainbow;
    localStorage.setItem('themeColor', themeColor);
    localStorage.setItem('isRainbowActive', isRainbowActive);

    window.electronAPI.updateTheme({ color, isRainbow });

    if (isRainbowActive) {
    } else {
      document.documentElement.style.setProperty('--primary-color', themeColor);
      document.documentElement.style.setProperty('--primary-dark', adjustColor(themeColor, -20));
    }

    updateSliderBackground(volumeSlider);
    updateSliderBackground(progressBar);
  }

  visualizerColorPicker.value = themeColor;
  updateThemeColor(themeColor, isRainbowActive);

  visualizerColorPicker.addEventListener('input', (e) => {
    updateThemeColor(e.target.value, false);
  });

rainbowToggleBtn.addEventListener('click', () => {
  isRainbowActive = !isRainbowActive;
  rainbowIcon.src = isRainbowActive ? 'build/flash.svg' : 'build/flashoff.svg';
  localStorage.setItem('isRainbowActive', isRainbowActive);
  if (isRainbowActive) {
    updateThemeColor(themeColor, true);
  } else {
    updateThemeColor(themeColor, false);
  }
});


const addStreamBtn = document.getElementById('addStreamBtn');
const streamModal = document.getElementById('streamModal');
const streamUrlInput = document.getElementById('streamUrlInput');
const streamNameInput = document.getElementById('streamNameInput');
const cancelStreamBtn = document.getElementById('cancelStreamBtn');
const addStreamConfirmBtn = document.getElementById('addStreamConfirmBtn');

addStreamBtn.addEventListener('click', () => {
  streamUrlInput.value = '';
  streamNameInput.value = '';
  streamModal.style.display = 'flex';
  streamUrlInput.focus();
});

cancelStreamBtn.addEventListener('click', () => {
  streamModal.style.display = 'none';
});

addStreamConfirmBtn.addEventListener('click', () => {
  let url = streamUrlInput.value.trim();
  if (!url) {
    alert('Fuck, enter a URL first!');
    return;
  }

  let name = streamNameInput.value.trim() || new URL(url).hostname;
  if (url.toLowerCase().endsWith('.pls') || url.toLowerCase().endsWith('.m3u')) {
    fetch(url)
      .then(r => r.text())
      .then(text => {
        const lines = text.split('\n');
        for (let line of lines) {
          line = line.trim();
          if (line.startsWith('File1=') || line.toLowerCase().includes('http')) {
            const match = line.match(/(https?:\/\/[^\s]+)/i);
            if (match) {
              addStreamToPlaylist(match[1], name);
              streamModal.style.display = 'none';
              return;
            }
          }
        }
        alert('No valid stream found in that playlist file');
      })
      .catch(err => {
        console.error(err);
        alert('Couldn\'t fetch the playlist file. Try a direct stream URL.');
      });
  } else {
    addStreamToPlaylist(url, name);
    streamModal.style.display = 'none';
  }
});


streamModal.addEventListener('click', (e) => {
  if (e.target === streamModal) {
    streamModal.style.display = 'none';
  }
});



function addStreamToPlaylist(url, customName = null) {
  const name = customName || new URL(url).hostname;

  const streamEntry = {
    url: url,
    name: name,
    isStream: true
  };

  audioFiles.push(streamEntry);
  renderPlaylist();
  updateStoredPlaylist();
  currentIndex = audioFiles.length - 1;
  playTrack(currentIndex);
}



let savedSortedOrder = []; 
let isShuffled = false;
shuffleBtn.classList.toggle('enabled', isShuffled);

shuffleBtn.addEventListener('click', () => {
  isShuffled = !isShuffled;
  shuffleBtn.classList.toggle('enabled', isShuffled);

  if (notifyEnabled && Notification.permission === 'granted') {
    window.electronAPI.notify(isShuffled ? 'Shuffle Enabled' : 'Shuffle Disabled');
  }

  if (audioFiles.length === 0) return;
  const currentSong = audioFiles[currentIndex];

  if (isShuffled) {
    if (savedSortedOrder.length === 0) {
      savedSortedOrder = [...audioFiles];
      
    }

    let remaining = [...audioFiles];
    remaining.splice(currentIndex, 1);
    shuffleArray(remaining);
    audioFiles = [currentSong, ...remaining];
    currentIndex = 0;
    selectedIndices.clear();
    selectedIndices.add(currentIndex);

  } else {
    audioFiles = [...savedSortedOrder];
    const newIndex = audioFiles.findIndex(song => {
      if (typeof song === 'string' && typeof currentSong === 'string') {
        return song === currentSong;
      }
      if (song?.isStream && currentSong?.isStream) {
        return song.url === currentSong.url;
      }
      if (song?.isJellyfin && currentSong?.isJellyfin) {
        return song.itemId === currentSong.itemId;
      }
      return false;
    });

    currentIndex = newIndex !== -1 ? newIndex : 0;
    selectedIndices.clear();
    selectedIndices.add(currentIndex);
  }

  renderPlaylist();
  updateSelectionVisuals();
  scrollToCurrentTrack();
});


function deepEqual(a, b) {
  if (a === b) return true;
  if (typeof a !== typeof b) return false;

  if (typeof a === 'string' && typeof b === 'string') return a === b;

  if (a && b && typeof a === 'object') {
    if (a.isStream && b.isStream) return a.url === b.url && a.name === b.name;
    if (a.isJellyfin && b.isJellyfin) return a.itemId === b.itemId && a.url === b.url;
  }

  return false;
}


function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}




  repeatBtn.addEventListener('click', () => {
    

  
    repeatTrack = !repeatTrack;
    repeatBtn.classList.toggle('enabled', repeatTrack);

    if (notifyEnabled && repeatTrack && Notification.permission === 'granted') {
    window.electronAPI.notify('Repeat Enabled');
  }

  if (notifyEnabled && !repeatTrack && Notification.permission === 'granted') {
    window.electronAPI.notify('Repeat Disabled');
  }
  });

  sortBtn.addEventListener('click', () => {
    if (sortMenu.style.display === 'block') {
      sortMenu.style.display = 'none';
    } else {
      sortMenu.style.display = 'block';
    }
  });

  const contextMenu = document.getElementById('contextMenu');
const removeTrackBtn = document.getElementById('removeTrackBtn');

removeTrackBtn.addEventListener('click', () => {
  if (selectedIndices.size === 0) return;

  const indicesToRemove = Array.from(selectedIndices).sort((a, b) => b - a);

  let shouldStopPlayback = false;
  indicesToRemove.forEach(idx => {
    if (idx === currentIndex) shouldStopPlayback = true;
    audioFiles.splice(idx, 1);
  });

  if (shouldStopPlayback || audioFiles.length === 0) {
    audio.pause();
    audio.src = '';
    currentIndex = 0;
    window.electronAPI.updateTrack({ songName: 'No Track', artUrl: null, isPlaying: false });
  } else if (currentIndex >= audioFiles.length) {
    currentIndex = audioFiles.length - 1;
  }

  selectedIndices.clear();
  lastSelectedIndex = null;
  renderPlaylist();
  if (audioFiles.length > 0) playTrack(currentIndex);

  contextMenu.style.display = 'none';
  contextMenuOpen = false;
});

playlistElem.addEventListener('contextmenu', (e) => {
  e.preventDefault();
  const li = e.target.closest('li');
  if (!li) return;

  const index = Array.from(playlistElem.children).indexOf(li);
  showContextMenu(e.clientX, e.clientY, index);
});

let contextMenuOpen = false;

function showContextMenu(x, y, index) {
  contextMenuOpen = true;
  contextMenu.style.left = `${x}px`;
  contextMenu.style.top = `${y}px`;
  contextMenu.style.display = 'block';
}


document.addEventListener('click', (e) => {
  if (contextMenuOpen && !contextMenu.contains(e.target)) {
    contextMenu.style.display = 'none';
    contextMenuOpen = false;
  }
});

  document.getElementById('sortNameAsc').addEventListener('click', () => {
    sortPlaylist('name', true);
    sortMenu.style.display = 'none';
  });

  document.getElementById('sortNameDesc').addEventListener('click', () => {
    sortPlaylist('name', false);
    sortMenu.style.display = 'none';
  });

  document.getElementById('sortDateAsc').addEventListener('click', () => {
    sortPlaylist('date', true);
    sortMenu.style.display = 'none';
  });

  document.getElementById('sortDateDesc').addEventListener('click', () => {
    sortPlaylist('date', false);
    sortMenu.style.display = 'none';
  });

  document.addEventListener('click', (e) => {
    if (!sortBtn.contains(e.target) && !sortMenu.contains(e.target)) {
      sortMenu.style.display = 'none';
    }
  });

async function sortPlaylist(criteria, ascending) {
  if (audioFiles.length === 0) return;

  let sortedFiles = [...audioFiles];
  const currentItem = audioFiles[currentIndex];

  if (criteria === 'name') {
    sortedFiles.sort((a, b) => {
      const getName = (item) => {
        if (typeof item === 'string') return item.split(/[\\/]/).pop().toLowerCase();
        if (item.isStream || item.isJellyfin) return (item.name || 'unknown').toLowerCase();
        return 'unknown';
      };
      const nameA = getName(a);
      const nameB = getName(b);
      return ascending ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
    });
  } else if (criteria === 'date') {
    const hasLocalFiles = audioFiles.some(item => typeof item === 'string');
    if (hasLocalFiles) {
      try {
        const filesWithDates = await Promise.all(
          sortedFiles.map(async (item) => {
            if (typeof item === 'string') {
              try {
                const stats = await window.electronAPI.getFileStats(item);
                return { item, date: stats?.mtimeMs ?? 0 };
              } catch {
                return { item, date: 0 };
              }
            } else {
              return { item, date: ascending ? Infinity : -Infinity };
            }
          })
        );

        filesWithDates.sort((a, b) => ascending ? a.date - b.date : b.date - a.date);

        sortedFiles = filesWithDates.map(x => x.item);
      } catch (err) {
        console.error('Date sort failed:', err);
        return sortPlaylist('name', ascending);
      }
    } else {
      return sortPlaylist('name', ascending);
    }
  }

  audioFiles = sortedFiles;
  const newIndex = audioFiles.findIndex(item => {
    if (currentItem === item) return true;
    if (typeof currentItem === 'object' && typeof item === 'object') {
      return currentItem.itemId === item.itemId || currentItem.url === item.url;
    }
    return false;
  });

  currentIndex = newIndex !== -1 ? newIndex : 0;
  selectedIndices.clear();
  selectedIndices.add(currentIndex);
  renderPlaylist();
  scrollToCurrentTrack();
  updateSelectionVisuals();

  localStorage.setItem('sortCriteria', criteria);
  localStorage.setItem('sortOrder', ascending ? 'asc' : 'desc');
}

 
const sortOptions = document.querySelectorAll('#sortMenu .sort-btn');

sortOptions.forEach(btn => {
  btn.addEventListener('click', () => {
    sortOptions.forEach(b => {
      b.textContent = b.textContent.replace(' ✓', '');
    });
    btn.textContent += ' ✓';
    document.getElementById('sortMenu').style.display = 'none';
  });
});

  function updateSortCheckmark(selectedId) {
    sortOptions.forEach(btn => {
      if (btn.id === selectedId) {
        if (!btn.textContent.includes(' ✓')) {
          btn.textContent += ' ✓';
        }
      } else {
        btn.textContent = btn.textContent.replace(' ✓', '');
      }
    });
  }

  playlistElem.addEventListener('dragover', (event) => {
    event.preventDefault();
    playlistElem.style.border = '2px dashed #212121';
  });

  window.addEventListener('resize', () => {
  setTimeout(visualize, 50);
});

  playlistElem.addEventListener('dragleave', (event) => {
    event.preventDefault();
    playlistElem.style.border = '';
  });
  const SAFE_DROP_LIMIT = 50;

  playlistElem.addEventListener('drop', async (event) => {
    event.preventDefault();
    playlistElem.style.border = '';
    const files = Array.from(event.dataTransfer.files);
    const audioExts = ['.mp3', '.wav', '.ogg', '.m4a', '.flac','.opus'];

    const droppedAudioFiles = files.filter(file => {
      const ext = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
      return audioExts.includes(ext);
    });

    if (droppedAudioFiles.length === 0) {
      alert('No supported audio files were dropped.');
      return;
    }

    const newPaths = droppedAudioFiles.map(f => f.path);
    audioFiles = audioFiles.concat(newPaths);
    renderPlaylist();
  });

  const clearPlaylistBtn = document.getElementById('clearPlaylistBtn');

  clearPlaylistBtn.addEventListener('click', () => {
    if (audioFiles.length === 0) return;
    audioFiles = [];
    currentIndex = 0;
    audio.pause();
    audio.src = '';
    visualizerCanvas.style.backgroundImage = 'none';
    visualizerCanvas.style.backgroundColor = '#111111';
    renderPlaylist();
    stopVideo();
    clearBackground();
    updateVideoSongName(`No Track`)
    window.electronAPI.updateTrack({ songName: 'No Track', artUrl: null, isPlaying: false });
  });

  [volumeSlider, progressBar].forEach(slider => {
    updateSliderBackground(slider);
    slider.addEventListener('input', () => updateSliderBackground(slider));
  });

  filePickerBtn.addEventListener('click', async () => {
  try {
    if ('Notification' in window && Notification.permission !== 'granted') {
      await Notification.requestPermission();
    }
    const result = await window.electronAPI.pickFolder();
    if (!result || result.canceled) {
      return;
    }
    const { folderPath, audioFilePaths } = result;
    if (!audioFilePaths.length) {
      alert('No audio files found in that folder');
      return;
    }

    
    audioFiles = audioFilePaths;
    savedSortedOrder = [];
    isShuffled = false;
    shuffleBtn.classList.remove('enabled');
    const input = document.getElementById('playlistQuickSearch');
    input.value = '';
    currentSearchTerm = '';
    document.getElementById('clearQuickSearch').style.display = 'none';
    renderPlaylist();

    
    await applySavedSort();

    updateStoredPlaylist();
    renderPlaylist();
    currentIndex = 0;
    playTrack(0);
    scrollToCurrentTrack(true);
  } catch (err) {
    console.error('Folder load error:', err);
    alert('Error: ' + err.message);
  }
});
  savePlaylistBtn.addEventListener('click', async () => {
    if (audioFiles.length === 0) {
      alert('No tracks to save!');
      return;
    }
    const playlist = audioFiles;
    const success = await window.electronAPI.savePlaylist(playlist);
    alert(success ? 'Playlist saved!' : 'Failed to save playlist');
  });

  loadPlaylistBtn.addEventListener('click', async () => {
    const { canceled, filePaths } = await window.electronAPI.openFile();
    if (canceled || !filePaths.length) return;

    const playlistPath = filePaths[0];
    const ext = playlistPath.split('.').pop().toLowerCase();

    if (ext === 'playlist') {
      const playlistData = await window.electronAPI.readFile(playlistPath);
      audioFiles = JSON.parse(playlistData);
    } else if (ext === 'm3u') {
      audioFiles = await parseM3UFile(playlistPath);
    } else {
      alert('Unsupported playlist format');
      return;
    }

    savedSortedOrder = [];
    isShuffled = false;
    shuffleBtn.classList.remove('enabled');

    currentIndex = 0;
    renderPlaylist();
    playTrack(currentIndex);
  });

  const volumePercent = document.getElementById('volumePercent');

  volumeSlider.addEventListener('input', (e) => {
    audio.volume = e.target.value;
    volumePercent.textContent = Math.round(e.target.value * 100) + '%';
    localStorage.setItem('volumeLevel', e.target.value);
    window.electronAPI.updateVolume(e.target.value);
  });

  const savedVolume = localStorage.getItem('volumeLevel');
  if (savedVolume !== null) {
    volumeSlider.value = savedVolume;
    audio.volume = savedVolume;
    volumePercent.textContent = Math.round(savedVolume * 100) + '%';
    updateSliderBackground(volumeSlider);
  } else {
    volumeSlider.value = 1;
    audio.volume = 1;
    volumePercent.textContent = '100%';
    updateSliderBackground(volumeSlider);
  }

 let lastSelectedIndex = null;

function renderPlaylist() {
  playlistElem.innerHTML = '';
  
  audioFiles.forEach((item, realIndex) => {
    let text = '';
    
    if (typeof item === 'string') {
      text = item.split(/[\\/]/).pop().toLowerCase();
    } else if (item.isStream || item.isJellyfin) {
      text = (item.name || '').toLowerCase();
    }
    
    if (currentSearchTerm && !text.includes(currentSearchTerm)) {
      return;
    }
    
    const li = document.createElement('li');
    if (typeof item === 'string') {
      li.textContent = item.split(/[\\/]/).pop();
    } else if (item.isStream) {
      li.innerHTML = '';
      const icon = document.createElement('img');
      icon.src = 'build/radio.svg';
      icon.style.width = '16px';
      icon.style.height = '16px';
      icon.style.marginRight = '8px';
      icon.style.verticalAlign = 'middle';
      icon.style.filter = 'brightness(0) invert(1)';
      const textSpan = document.createElement('span');
      textSpan.textContent = item.name || 'Unknown Station';
      li.appendChild(icon);
      li.appendChild(textSpan);
    } else if (item.isJellyfin) {
      li.textContent = item.name || 'Unknown Track';
    } else {
      li.textContent = 'Unknown Track';
    }
    
    const isActive = (realIndex === currentIndex);
    const isPlaying = isActive && !audio.paused && audioFiles.length > 0;
    
    if (isPlaying) {
      const gifWrapper = document.createElement('div');
      gifWrapper.style.position = 'absolute';
      gifWrapper.style.left = '9px';
      gifWrapper.style.top = '42%';
      gifWrapper.style.transform = 'translateY(-50%)';
      gifWrapper.style.pointerEvents = 'none';
      gifWrapper.style.zIndex = '10';
      const gifImg = document.createElement('img');
      gifImg.src = 'build/bars.gif';
      gifImg.style.width = '25px';
      gifImg.style.height = '25px';
      gifImg.style.objectFit = 'contain';
      gifWrapper.appendChild(gifImg);
      li.style.paddingLeft = '37px';
      li.style.position = 'relative';
      if (lowPerfMode) {
    gifWrapper.style.display = 'none';
  }
      li.appendChild(gifWrapper);
    }
    
    li.dataset.realIndex = realIndex;
    
    li.addEventListener('click', (e) => {
      if (contextMenuOpen) {
        contextMenu.style.display = 'none';
        contextMenuOpen = false;
        e.stopPropagation();
        return;
      }
      
      const realIdx = parseInt(li.dataset.realIndex);
      
      if (e.shiftKey && lastSelectedIndex !== null) {
        const start = Math.min(lastSelectedIndex, realIdx);
        const end = Math.max(lastSelectedIndex, realIdx);
        selectedIndices.clear();
        for (let i = start; i <= end; i++) selectedIndices.add(i);
      } else if (e.ctrlKey || e.metaKey) {
        if (selectedIndices.has(realIdx)) selectedIndices.delete(realIdx);
        else selectedIndices.add(realIdx);
        lastSelectedIndex = realIdx;
      } else {
        selectedIndices.clear();
        selectedIndices.add(realIdx);
        lastSelectedIndex = realIdx;
        currentIndex = realIdx;
        playTrack(realIdx);
      }
      
      updateSelectionVisuals();
    });
    
    if (selectedIndices.has(realIndex)) {
      li.classList.add('selected');
    }
    if (isActive) {
      li.classList.add('active');
    }
    
    playlistElem.appendChild(li);
  });
  
  updateSelectionVisuals();
}


const selectedIndices = new Set();

function updateSelectionVisuals() {
  const items = playlistElem.querySelectorAll('li');
  items.forEach(li => {
    const idx = parseInt(li.dataset.realIndex);
    li.classList.toggle('selected', selectedIndices.has(idx));
    li.classList.toggle('active', idx === currentIndex);
  });
}

  async function parseM3UFile(filePath) {
    const content = await window.electronAPI.readFile(filePath);
    const lines = content
      .split(/\r?\n/)
      .map(line => line.trim())
      .filter(line => line && !line.startsWith('#'));

    const pathSeparator = window.navigator.platform.startsWith('Win') ? '\\' : '/';
    const baseDir = filePath.substring(0, filePath.lastIndexOf(pathSeparator));

    const audioPaths = lines.map(line => {
      if (line.startsWith('/') || /^[a-zA-Z]:\\/.test(line)) return line;
      return baseDir + (baseDir.endsWith(pathSeparator) ? '' : pathSeparator) + line;
    });

    return audioPaths;
  }

 async function getAlbumArtUrl(filePath) {
  const defaultImage = 'build/default-artwork.jpg';
  if (typeof filePath !== 'string') return defaultImage;
  let embeddedArt = null;
  try {
    const buffer = await window.electronAPI.readFileBuffer(filePath);
    const arrayBuffer = buffer.buffer.slice(buffer.byteOffset, buffer.byteOffset + buffer.byteLength);
    const blob = new Blob([arrayBuffer]);

    embeddedArt = await new Promise((resolve) => {
      jsmediatags.read(blob, {
        onSuccess: (tag) => {
          const picture = tag.tags?.picture;
          if (picture) {
            let binary = '';
            const uint8Array = new Uint8Array(picture.data);
            for (let i = 0; i < uint8Array.length; i++) binary += String.fromCharCode(uint8Array[i]);
            const base64 = btoa(binary);
            const mime = picture.format || 'image/jpeg';
            resolve(`data:${mime};base64,${base64}`);
          } else resolve(null);
        },
        onError: (err) => {
          console.debug(`No embedded art in ${filePath.split('/').pop()}: ${err.info}`);
          resolve(null);
        }
      });
    });
  } catch (err) {
    console.debug('jsmediatags skipped or failed (normal for many files)');
  }

  if (embeddedArt) return embeddedArt;
  try {
    const ext = await window.electronAPI.pathExtname(filePath);
    const baseName = await window.electronAPI.pathBasename(filePath, ext);
    const dir = await window.electronAPI.pathDirname(filePath);

    const candidates = [
      baseName + '.jpg',
      baseName + '.jpeg',
      baseName + '.png',
      baseName + '.webp',
      baseName + '.gif',
      'cover.jpg',
      'folder.jpg',
      'albumart.jpg',
      'front.jpg',
      'cover.png',
      'folder.png'
    ];

    for (const name of candidates) {
      const candidatePath = await window.electronAPI.pathJoin(dir, name);
      if (await window.electronAPI.fileExists(candidatePath)) {
        const normalized = candidatePath.replace(/\\/g, '/');
        const url = `file://${encodeURI(normalized).replace(/#/g, '%23')}`;
        return url;
      }
    }
  } catch (err) {
    console.warn('External art search failed:', err);
  }
  return defaultImage;
}


function stopVideo() {
    if (visualizerVideo) {
        visualizerVideo.pause();
        visualizerVideo.src = '';  
        visualizerVideo.load();                      
        visualizerVideo.style.display = 'none';      
        visualizerVideo.style.opacity = '0';
    }
}

function clearBackground() {
  visualizerCanvas.style.backgroundImage = 'none';
  visualizerCanvas.style.backgroundColor = '#111111';
  currentArtImage = null;
  visualizerCanvas.style.backgroundColor = 'transparent';
  document.getElementById('visualizerBgGif').style.display = 'none';
}

const visualizerVideo = document.getElementById('visualizerVideo');
const songNameOverlay = document.getElementById('videoSongName');

let videoOnlyMode = false;
let originalWindowWidth =  441;
let originalWindowHeight = 743;



async function setVideoOnlyBackground(item) {
    let artworkEl = document.getElementById('artworkLayer');
    if (!artworkEl) {
        artworkEl = document.createElement('img');
        artworkEl.id = 'artworkLayer';
        artworkEl.style.cssText = `
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
            pointer-events: none;
            display: block;
        `;
    }

    artworkEl.src = '';
    let usedGifOrVideo = false;

    if (typeof item === 'string') {
        const filePath = item;
        const dir = await window.electronAPI.pathDirname(filePath);
        const ext = await window.electronAPI.pathExtname(filePath);
        const baseName = await window.electronAPI.pathBasename(filePath, ext);
        const videoCandidates = [
            baseName + '.mp4',
            baseName + '.webm',
            baseName + '-video.mp4',
            baseName + '-preview.mp4'
        ];

        for (const name of videoCandidates) {
            const candidatePath = await window.electronAPI.pathJoin(dir, name);
            if (await window.electronAPI.fileExists(candidatePath) && gifPreviewEnabled) {
                const normalized = candidatePath.replace(/\\/g, '/');
                const encoded = encodeURI(normalized).replace(/#/g, '%23');
                artworkEl.src = `file://${encoded}`;
                usedGifOrVideo = true;
                break;
            }
        }

        if (usedGifOrVideo) {
            artworkEl.style.display = 'block';
            return;
        }

        const sameNameGif = baseName + '.gif';
        const sameNameGifPath = await window.electronAPI.pathJoin(dir, sameNameGif);
        if (await window.electronAPI.fileExists(sameNameGifPath) && gifPreviewEnabled) {
            const normalized = sameNameGifPath.replace(/\\/g, '/');
            const encoded = encodeURI(normalized).replace(/#/g, '%23');
            artworkEl.src = `file://${encoded}`;
            usedGifOrVideo = true;
        }

        if (usedGifOrVideo) {
            artworkEl.style.display = 'block';
            return;
        }

        const artUrl = await getAlbumArtUrl(filePath);
        if (artUrl && artUrl !== 'build/default-artwork.jpg') {
            artworkEl.src = artUrl;
            return;
        }

        const coverGifName = 'cover.gif';
        const coverGifPath = await window.electronAPI.pathJoin(dir, coverGifName);
        if (await window.electronAPI.fileExists(coverGifPath) && gifPreviewEnabled) {
            const normalized = coverGifPath.replace(/\\/g, '/');
            const encoded = encodeURI(normalized).replace(/#/g, '%23');
            artworkEl.src = `file://${encoded}`;
            usedGifOrVideo = true;
        }

        if (usedGifOrVideo) {
            artworkEl.style.display = 'block';
            return;
        }
    } 
    else if (item?.isJellyfin && item.albumArt) {
        artworkEl.src = item.albumArt;
        return;
    }
    artworkEl.src = 'build/default-artwork.jpg';
    artworkEl.style.display = 'block';
}

document.getElementById('popoutVideoBtn').addEventListener('click', async () => {
    videoOnlyMode = !videoOnlyMode;
    const container = document.getElementById('container');
    const btn = document.getElementById('popoutVideoBtn');
    const btnImg = btn.querySelector('img');
    const currentSongTitle = displayName || 'Unknown Track';

    window.electronAPI?.resizeWindow?.(1241, 743);

    if (!videoOnlyMode) {
        document.body.classList.remove('video-only');
        songNameOverlay.style.display = 'none';
        const oldArtwork = document.getElementById('artworkLayer');
        if (oldArtwork) oldArtwork.remove();
        if (originalWindowWidth && originalWindowHeight) {
            window.electronAPI?.resizeWindow?.(
                originalWindowWidth,
                originalWindowHeight
            );
        }
        setTimeout(() => window.dispatchEvent(new Event('resize')), 120);
        return;
    }

    document.body.classList.add('video-only');
    updateVideoSongName(currentSongTitle)
    songNameOverlay.style.display = 'block';
    btnImg.style.filter = 'invert(1)';
    btn.style.backdropFilter = 'blur(10px)';
    btn.style.borderRadius = '50%';
    btn.style.padding = '12px';
    btn.style.boxShadow = '0 6px 20px rgba(0,0,0,0.7)';
    let artworkEl = document.getElementById('artworkLayer');
    if (!artworkEl) {
        artworkEl = document.createElement('img');
        artworkEl.id = 'artworkLayer';
        artworkEl.style.cssText = `
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 5;
            pointer-events: none;
            display: block;
        `;
        container.prepend(artworkEl);
    }
    const currentItem = audioFiles[currentIndex];
    if (currentItem) {
        console.log("Setting video-only background for:", currentItem);
        await setVideoOnlyBackground(currentItem);
    } else {
        artworkEl.src = 'build/default-artwork.jpg';
    }
});



function updateVideoSongName(title) {
  const maxLength = 60;
  if (title.length > maxLength) {
    songNameOverlay.textContent = title.slice(0, maxLength - 3) + "...";
  } else {
    songNameOverlay.textContent = title;
  }
}

async function setVisualizerBackground(item) {
    stopVideo();
    visualizerCanvas.style.backgroundImage = 'none';
    visualizerCanvas.style.backgroundColor = '#111111';
    currentArtImage = null;

    let artUrl = null;
    let usedGifOrVideo = false;

    if (typeof item === 'string') {
        const filePath = item;
        const dir = await window.electronAPI.pathDirname(filePath);
        const ext = await window.electronAPI.pathExtname(filePath);
        const baseName = await window.electronAPI.pathBasename(filePath, ext);
        const videoCandidates = [
            baseName + '.mp4',
            baseName + '.webm',
            baseName + '-video.mp4',
            baseName + '-preview.mp4'
        ];

        for (const name of videoCandidates) {
    const candidatePath = await window.electronAPI.pathJoin(dir, name);
    if (await window.electronAPI.fileExists(candidatePath) && gifPreviewEnabled) {
        const normalized = candidatePath.replace(/\\/g, '/');
        const encoded = encodeURI(normalized).replace(/#/g, '%23');
        visualizerVideo.src = `file://${encoded}`;
        visualizerVideo.style.display = 'block';          
        visualizerVideo.style.opacity = '1';              
        visualizerVideo.style.zIndex = '0';              
        visualizerVideo.currentTime = 0;
        visualizerVideo.loop = true;
        visualizerVideo.muted = true;
        visualizerVideo.playsInline = true;
        try {
            await visualizerVideo.play();
            visualizerCanvas.style.backgroundColor = 'transparent';
            visualizerCanvas.style.backgroundImage = 'none';
        } catch (err) {
            console.error("Video play failed:", err);
        }

        usedGifOrVideo = true;
        break;
    }
}

        if (usedGifOrVideo) return;
        const sameNameGif = baseName + '.gif';
        const sameNameGifPath = await window.electronAPI.pathJoin(dir, sameNameGif);
       if (await window.electronAPI.fileExists(sameNameGifPath) && gifPreviewEnabled) {
        const normalized = sameNameGifPath.replace(/\\/g, '/');
        const encoded = encodeURI(normalized).replace(/#/g, '%23');
        const gifUrl = `file://${encoded}`;
        visualizerVideo.style.display = 'none';
        const gifElement = document.getElementById('visualizerBgGif');
        if (gifElement) {
            gifElement.src = gifUrl;
            gifElement.style.display = 'block';
            gifElement.style.objectFit = 'contain';
            gifElement.style.objectPosition = 'center';
        } else {
            console.warn("visualizerBgGif element not found in DOM!");
        }

        usedGifOrVideo = true;
    }

        if (usedGifOrVideo) return;
        artUrl = await getAlbumArtUrl(filePath);
        if (artUrl && artUrl !== 'build/default-artwork.jpg') {
            const loader = document.getElementById('artLoader');
            if (loader) {
                loader.src = artUrl;
                loader.onload = () => {
                    currentArtImage = loader;
                };
                loader.onerror = () => {
                    console.warn("[ART] Album art failed to load");
                    visualizerCanvas.style.backgroundImage = `url('build/default-artwork.jpg')`;
                };
            }
            return;
        }
        const coverGifName = 'cover.gif';
        const coverGifPath = await window.electronAPI.pathJoin(dir, coverGifName);
        if (await window.electronAPI.fileExists(coverGifPath) && gifPreviewEnabled) {
            const normalized = coverGifPath.replace(/\\/g, '/');
            const encoded = encodeURI(normalized).replace(/#/g, '%23');
            visualizerVideo.style.display = 'none';
            visualizerCanvas.style.backgroundImage = `url("file://${encoded}")`;
            visualizerCanvas.style.backgroundSize = 'cover';          
              visualizerCanvas.style.backgroundPosition = 'center';
              visualizerCanvas.style.backgroundRepeat = 'no-repeat';
              visualizerCanvas.style.imageRendering = 'auto';
            usedGifOrVideo = true;
        }
    } 
    else if (item?.isJellyfin && item.albumArt) {
        artUrl = item.albumArt;

        const loader = document.getElementById('artLoader');
        if (loader) {
            loader.src = artUrl;
            loader.onload = () => { currentArtImage = loader; };
            loader.onerror = () => {
                visualizerCanvas.style.backgroundImage = `url('build/default-artwork.jpg')`;
            };
        }
        return;
    }

    if (!usedGifOrVideo && (!artUrl || artUrl === 'build/default-artwork.jpg')) {
        visualizerCanvas.style.backgroundImage = `url('build/default-artwork.jpg')`;
        visualizerCanvas.style.backgroundSize = 'cover';
        visualizerCanvas.style.backgroundPosition = 'center';
    }
}


  async function playTrack(index) {
  stopVideo()
  if (index < 0 || index >= audioFiles.length) return;



  currentIndex = index;
  selectedIndices.clear();
  selectedIndices.add(currentIndex);
  lastSelectedIndex = currentIndex;

  const item = audioFiles[index];


  if (typeof item === 'string') {
  const normalizedPath = item.replace(/\\/g, '/');
  const encodedPath = encodeURI(normalizedPath).replace(/#/g, '%23');
  src = `file://${encodedPath}`;

  displayName = normalizedPath.split('/').pop();



  } else if (item.isStream) {
    src = item.url;
    displayName = item.name || 'Radio Stream';
} else if (item.isJellyfin) {
    src = item.url;
    displayName = item.name;
} else {
    return;
}

 if (Hls.isSupported() && src.endsWith('.m3u8') || src.includes('.m3u8?')) {
    const hls = new Hls();
    hls.loadSource(src);
    hls.attachMedia(audio);
    hls.on(Hls.Events.MANIFEST_PARSED, () => {
      audio.play();
    });
  
    hls.on(Hls.Events.ERROR, (event, data) => {
      if (data.fatal) {
        console.error('Fatal HLS error:', data);
        audio.src = src;
        audio.play();
      }
    });
  } else {
    audio.src = src;
    audio.play();
  }
  await setVisualizerBackground(item);

  const trackData = {
    songName: displayName,
    artUrl: visualizerCanvas.style.backgroundImage.slice(5, -2) || null,
    isPlaying: true,
    volume: audio.volume
  };

  updateVideoSongName(displayName);
  setVideoOnlyBackground(item)
  window.electronAPI.updateTrack(trackData);

  renderPlaylist();
  updateSelectionVisuals();
  visualize();
  scrollToCurrentTrack();

  if (item.isJellyfin) {
  src = item.url;
  displayName = item.name;
  if (item.albumArt) {
    visualizerCanvas.style.backgroundImage = `url(${item.albumArt})`;
  }
}
  if (item.isStream) {
    currentTimeElem.textContent = 'LIVE';
    durationElem.textContent = '∞';
  } else {
    currentTimeElem.textContent = '0:00';
    durationElem.textContent = '0:00';
  }

  if (notifyEnabled && Notification.permission === 'granted') {
    window.electronAPI.notify('Now Playing', displayName);
  }
}


const playPauseBtn = document.getElementById('playPauseBtn');
const playPauseIcon = document.getElementById('playPauseIcon');

playPauseBtn.addEventListener('click', () => {
  if (audio.paused) {
    audio.play();
    visualizerVideo.play();
    if (notifyEnabled && Notification.permission === 'granted') {
    window.electronAPI.notify('Resuming');
  }
  } else {
    audio.pause();
    visualizerVideo.pause();
    if (notifyEnabled && Notification.permission === 'granted') {
    window.electronAPI.notify('Paused');
  }
  }
});


audio.addEventListener('play', () => {
  renderPlaylist();
  playPauseIcon.src = 'build/pause.svg';
  playPauseIcon.alt = 'Pause';
  window.electronAPI.updateTrack({ isPlaying: true });
});

audio.addEventListener('pause', () => {
  renderPlaylist();
  playPauseIcon.src = 'build/play.svg';
  playPauseIcon.alt = 'Play';
  window.electronAPI.updateTrack({ isPlaying: false });
});


if (audio.paused) {
  playPauseIcon.src = 'build/play.svg';
} else {
  playPauseIcon.src = 'build/pause.svg';
}

  volumeSlider.addEventListener('input', (e) => {
    audio.volume = e.target.value;
  });

  audio.addEventListener('play', () => {
    window.electronAPI.updateTrack({ isPlaying: true, volume: audio.volume });
  });

  audio.addEventListener('pause', () => {
    window.electronAPI.updateTrack({ isPlaying: false, volume: audio.volume });
  });
audio.addEventListener('timeupdate', () => {
  const currentItem = audioFiles[currentIndex];

  if (!isSeeking) {
    if (currentItem && currentItem.isStream) {
      currentTimeElem.textContent = 'LIVE';
      durationElem.textContent = '∞';
      progressBar.value = 0;
      progressBar.max = 1;
      window.electronAPI.updateTime(0, Infinity);
    } else if (audio.duration && isFinite(audio.duration)) {
      progressBar.max = audio.duration;
      progressBar.value = audio.currentTime;
      currentTimeElem.textContent = formatTime(audio.currentTime);
      durationElem.textContent = formatTime(audio.duration);
      window.electronAPI.updateTime(audio.currentTime, audio.duration);
    }
    updateSliderBackground(progressBar);
  }
});


progressBar.addEventListener('input', () => {
    const newTime = parseFloat(progressBar.value);
    if (!isNaN(newTime) && audio.duration) {
        audio.currentTime = newTime;
    }
    if (gifPreviewEnabled && visualizerVideo.src && visualizerVideo.style.display !== 'none') {
        if (!isNaN(visualizerVideo.duration) && isFinite(visualizerVideo.duration)) {
            const target = newTime % visualizerVideo.duration;
            if (Math.abs(visualizerVideo.currentTime - target) > 0.3) {
                visualizerVideo.currentTime = target;
            }
        }
    }
});


progressBar.addEventListener('change', () => {
    const newTime = parseFloat(progressBar.value);
    if (!isNaN(newTime) && audio.duration) {
        audio.currentTime = newTime;
    }
    
    isSeeking = false;
});

  function formatTime(seconds) {
    const m = Math.floor(seconds / 60);
    const s = Math.floor(seconds % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
  }

let energyHistory;
let lastBeat = false;
let lastWidth = 0;
let lastHeight = 0;

function visualize() {
  if (animationFrameId) {
    cancelAnimationFrame(animationFrameId);
    animationFrameId = null;
  }

  const canvas = visualizerCanvas;
  const width = canvas.offsetWidth;
  const height = canvas.offsetHeight;

  if (width !== lastWidth || height !== lastHeight) {
    canvas.width = width;
    canvas.height = height;
    lastWidth = width;
    lastHeight = height;
  }

  const ctx = canvas.getContext('2d');
  const bufferLength = analyser.frequencyBinCount;
  const dataArray = new Uint8Array(bufferLength);

  let frameCounter = 0;
  let lastTime = 0;

  function draw(timestamp) {
    animationFrameId = requestAnimationFrame(draw);
    if (lastTime && (timestamp - lastTime) < 33) return;
    lastTime = timestamp || performance.now();
    if (canvas.width !== width || canvas.height !== height) {
      canvas.width = width;
      canvas.height = height;
    }

    ctx.clearRect(0, 0, width, height);
    if (currentArtImage && currentArtImage.complete && currentArtImage.naturalWidth > 0) {
      try {
        const scale = Math.max(
          width / currentArtImage.naturalWidth,
          height / currentArtImage.naturalHeight
        );
        const drawW = currentArtImage.naturalWidth * scale;
        const drawH = currentArtImage.naturalHeight * scale;
        const offsetX = (width - drawW) / 2;
        const offsetY = (height - drawH) / 2;

        ctx.globalAlpha = 0.4;
        ctx.drawImage(currentArtImage, offsetX, offsetY, drawW, drawH);
        ctx.globalAlpha = 1.0;
      } catch (e) {
        console.warn('[VISUALIZER] Failed to draw art this frame:', e);
      }
    }

    let songName = 'No Track';
    let isRadioStream = false;
    const currentItem = audioFiles[currentIndex];
    if (currentItem) {
      if (typeof currentItem === 'string') {
        songName = currentItem.split(/[\\/]/).pop() || 'Unknown Track';
      } else if (currentItem.isStream) {
        isRadioStream = true;
        songName = currentItem.name?.trim() || (new URL(currentItem.url).hostname || 'Radio Stream');
      } else if (currentItem.isJellyfin) {
        songName = currentItem.name || 'Unknown Track';
      }
    }
    if (songName.length > 50) songName = songName.slice(0, 47) + '...';

    const isMini = document.body.classList.contains('mini-mode');
    const iconSize = isMini ? 10 : 14;
    const textY = isMini ? 14 : 18;
    const maxWidth = width * 0.92;
    ctx.font = isMini ? '10.5px Arial' : '14px Arial';
    ctx.textAlign = 'center';
    ctx.fillStyle = '#FFFFFF';
    ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
    ctx.shadowBlur = 3;
    ctx.shadowOffsetX = 1;
    ctx.shadowOffsetY = 1;

    let displayText = songName;
    let textWidth = ctx.measureText(displayText).width;
    if (textWidth > maxWidth) {
      const ellipsis = '...';
      let availableWidth = maxWidth - ctx.measureText(ellipsis).width;
      let low = 0, high = songName.length;
      while (low < high) {
        let mid = Math.floor((low + high + 1) / 2);
        let testText = songName.slice(0, mid);
        if (ctx.measureText(testText).width <= availableWidth) low = mid;
        else high = mid - 1;
      }
      displayText = songName.slice(0, low) + ellipsis;
    }

    let textX = width / 2;
    if (isRadioStream && radioIconImg.complete) {
      const totalWidth = ctx.measureText(displayText).width + iconSize + 8;
      const startX = width / 2 - totalWidth / 2;
      ctx.save();
      ctx.filter = 'brightness(0) invert(1)';
      ctx.drawImage(radioIconImg, startX, textY - iconSize + 2, iconSize, iconSize);
      ctx.restore();
      textX = startX + iconSize + 8 + ctx.measureText(displayText).width / 2;
    }
    ctx.globalAlpha = 1.0;
    ctx.fillText(displayText, textX, textY);

    ctx.shadowColor = 'transparent';
    ctx.shadowBlur = 0;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 0;

    if (!visualizerToggle || !analyser || !isMainWindowVisible) return;

    analyser.getByteFrequencyData(dataArray);
    frameCounter++;
    if (frameCounter % 2 === 0 && window.electronAPI?.updateVisualizer) {
      window.electronAPI.updateVisualizer(Array.from(dataArray));
    }

    let lowEnergy = 0;
    for (let i = 0; i < 10; i++) lowEnergy += dataArray[i] * dataArray[i];
    lowEnergy = Math.sqrt(lowEnergy / 10);

    if (!energyHistory) energyHistory = [];
    energyHistory.push(lowEnergy);
    if (energyHistory.length > 32) energyHistory.shift();

    const avgEnergy =
      energyHistory.reduce((a, b) => a + b, 0) / energyHistory.length;

    let isBeat = false;

    if (lowEnergy > Math.max(avgEnergy * 1.3, 80) && !lastBeat) {
      isBeat = true;
      lastBeat = true;
    } else if (lowEnergy < avgEnergy * 1.1) {
      lastBeat = false;
    }

    const currentPrimaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim() || '#a88cff';

    if (isRainbowActive) {
      let bass = 0, mids = 0;
      for (let i = 0; i < 6; i++) bass += dataArray[i];
      for (let i = 12; i < 22; i++) mids += dataArray[i];
      bass /= 6; mids /= 10;

      if (window.prevBass === undefined) window.prevBass = bass;
      if (window.prevMids === undefined) window.prevMids = mids;

      const bassDelta = bass - window.prevBass;
      const midDelta = mids - window.prevMids;
      window.prevBass = bass;
      window.prevMids = mids;

      if (!window.bassDeltaHist) window.bassDeltaHist = [];
      window.bassDeltaHist.push(bassDelta);
      if (window.bassDeltaHist.length > 20) window.bassDeltaHist.shift();

      const avgBassDelta = window.bassDeltaHist.reduce((a, b) => a + b, 0) / window.bassDeltaHist.length;
      const now = performance.now();
      if (!window.lastBeatTime) window.lastBeatTime = 0;

      let triggerBeat = false;
      if (bassDelta > avgBassDelta * 1.8 && bassDelta > 4 && bassDelta > midDelta * 1.5 && now - window.lastBeatTime > 1) {
        triggerBeat = true;
        window.lastBeatTime = now;
      }

      if (window.rainbowHue === undefined) window.rainbowHue = Math.floor(Math.random() * 360);
      if (triggerBeat) window.rainbowHue = (window.rainbowHue + 60) % 360;

      const color = `hsl(${window.rainbowHue}, 100%, ${triggerBeat ? 70 : 55}%)`;
      const darkColor = `hsl(${window.rainbowHue}, 100%, ${triggerBeat ? 40 : 30}%)`;
      document.documentElement.style.setProperty('--primary-color', color);
      document.documentElement.style.setProperty('--primary-dark', darkColor);
    }

    if (visualizerMode === 'bars') {
      const barCount = isMini ? 48 : 64;
      const step = Math.max(1, Math.floor(bufferLength / barCount));
      const barWidth = Math.max(1.5, (width / barCount) * 0.8);
      const centerX = width / 2;
      const spacing = 1;
      const gradient = ctx.createLinearGradient(0, 0, 0, height);
      gradient.addColorStop(0, currentPrimaryColor);
      gradient.addColorStop(0.5, adjustColor(currentPrimaryColor, -20));
      gradient.addColorStop(1, currentPrimaryColor);
      ctx.fillStyle = gradient;

      for (let i = 0; i < barCount; i++) {
        const value = dataArray[i * step] || 0;
        const barHeight = value * (height / 255) * (isMini ? 0.7 : 0.55);
        const xLeft = centerX - (i + 1) * (barWidth + spacing);
        const xRight = centerX + i * (barWidth + spacing);
        const y = height - barHeight;

        if (xLeft + barWidth > 0) ctx.fillRect(xLeft, y, barWidth, barHeight);
        if (xRight < width) ctx.fillRect(xRight, y, barWidth, barHeight);
      }
    }  else if (visualizerMode === 'bubbles') {
        if (window.katBubbles) window.katBubbles = [];
        if (window.nukeBubbles) window.nukeBubbles = [];
        if (!window.bubbles) window.bubbles = [];

        const MAX_BUBBLES = 25;
        const bassLevel = lowEnergy / 255;

  if (Math.random() < bassLevel * 0.35) {
    const img = getRandomBubbleImage(bubbleImages);
    if (img) {
      window.bubbles.push({
        x: Math.random() * width,
        y: height + 30,
        img: img,
        size: 20 + Math.random() * 30,
        speedY: 1.2 + Math.random() * 2,
        speedX: (Math.random() - 0.5) * 1,
        opacity: 0.7 + Math.random() * 0.3
      });
    }
  }

  if (isBeat && window.bubbles.length < MAX_BUBBLES) {
    const burstCount = 3 + Math.floor(Math.random() * 5);
    for (let i = 0; i < burstCount; i++) {
      const img = getRandomBubbleImage(bubbleImages);
      if (img) {
        window.bubbles.push({
          x: Math.random() * width,
          y: height + 50,
          img: img,
          size: 50 + Math.random() * 60,
          speedY: 3 + Math.random() * 5,
          speedX: (Math.random() - 0.5) * 4,
          opacity: 1
        });
      }
    }
  }

  for (let i = window.bubbles.length - 1; i >= 0; i--) {
  const b = window.bubbles[i];
  b.y -= b.speedY;
  b.x += b.speedX;
  b.opacity -= 0.004;

  const x = b.x - b.size / 2;
  const y = b.y - b.size / 2;

  ctx.globalAlpha = Math.max(0, b.opacity);

  ctx.save();
  ctx.drawImage(b.img, x, y, b.size, b.size);
  const primary = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim() || '#a88cff';
  ctx.shadowColor = primary;
  ctx.shadowBlur = b.size * 0.4;
  ctx.shadowOffsetX = 0;
  ctx.shadowOffsetY = 0;
  ctx.globalAlpha = 1;
  ctx.globalCompositeOperation = 'lighter';
  ctx.drawImage(b.img, x, y, b.size, b.size);
  ctx.shadowBlur = 0;
  ctx.globalCompositeOperation = 'source-over';
  ctx.globalAlpha = 1;
  ctx.restore();

  if (b.y + b.size < -50 || b.opacity <= 0) {
    window.bubbles.splice(i, 1);
  }
}

    } else if (visualizerMode === 'katbubbles') {
      if (window.bubbles) window.bubbles = [];
      if (window.nukeBubbles) window.nukeBubbles = [];
      if (!window.katBubbles) window.katBubbles = [];

      const MAX_KAT_BUBBLES = 25;
      const bassLevel = lowEnergy / 255;

      if (Math.random() < bassLevel * 0.35) {
        const img = getRandomBubbleImage(katbubbleImages);
        if (img) {
          window.katBubbles.push({
            x: Math.random() * width,
            y: height + 30,
            img: img,
            size: 15 + Math.random() * 20,
            speedY: 1.2 + Math.random() * 2,
            speedX: (Math.random() - 0.5) * 1,
            opacity: 0.7 + Math.random() * 0.3
          });
        }
      }

      if (isBeat && window.katBubbles.length < MAX_KAT_BUBBLES) {
        const burstCount = 3 + Math.floor(Math.random() * 5);
        for (let i = 0; i < burstCount; i++) {
          const img = getRandomBubbleImage(katbubbleImages);
          if (img) {
            window.katBubbles.push({
              x: Math.random() * width,
              y: height + 50,
              img: img,
              size: 30 + Math.random() * 40,
              speedY: 3 + Math.random() * 5,
              speedX: (Math.random() - 0.5) * 4,
              opacity: 1
            });
          }
        }
      }

      for (let i = window.katBubbles.length - 1; i >= 0; i--) {
        const b = window.katBubbles[i];
        b.y -= b.speedY;
        b.x += b.speedX;
        b.opacity -= 0.004;
        ctx.save();
        ctx.drawImage(b.img, b.x, b.y, b.size, b.size);
        const primary = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim() || '#a88cff';
        ctx.shadowColor = primary;
        ctx.shadowBlur = b.size * 0.4;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 0;
        ctx.globalAlpha = 0.3;
        ctx.globalCompositeOperation = 'lighter';
        ctx.drawImage(b.img, b.x, b.y, b.size, b.size);
        ctx.shadowBlur = 0;
        ctx.globalCompositeOperation = 'source-over';
        ctx.globalAlpha = 0.11;
        ctx.restore();
        if (b.y + b.size < -50 || b.opacity <= 0) {
          window.katBubbles.splice(i, 1);
        }
      }
    } else if (visualizerMode === 'nukebubbles') {
      if (window.bubbles) window.bubbles = [];
      if (window.katBubbles) window.katBubbles = [];
      if (!window.nukeBubbles) window.nukeBubbles = [];

      const MAX_NUKE_BUBBLES = 25;
      const bassLevel = lowEnergy / 255;

      if (Math.random() < bassLevel * 0.35) {
        const img = getRandomBubbleImage(nukebubbleImages);
        if (img) {
          window.nukeBubbles.push({
            x: Math.random() * width,
            y: height + 30,
            img: img,
            size: 15 + Math.random() * 20,
            speedY: 1.2 + Math.random() * 2,
            speedX: (Math.random() - 0.5) * 1,
            opacity: 0.7 + Math.random() * 0.3
          });
        }
      }

      if (isBeat && window.nukeBubbles.length < MAX_NUKE_BUBBLES) {
        const burstCount = 3 + Math.floor(Math.random() * 5);
        for (let i = 0; i < burstCount; i++) {
          const img = getRandomBubbleImage(nukebubbleImages);
          if (img) {
            window.nukeBubbles.push({
              x: Math.random() * width,
              y: height + 50,
              img: img,
              size: 30 + Math.random() * 40,
              speedY: 3 + Math.random() * 5,
              speedX: (Math.random() - 0.5) * 4,
              opacity: 1
            });
          }
        }
      }

      for (let i = window.nukeBubbles.length - 1; i >= 0; i--) {
        const b = window.nukeBubbles[i];
        b.y -= b.speedY;
        b.x += b.speedX;
        b.opacity -= 0.004;
        ctx.save();
        ctx.drawImage(b.img, b.x, b.y, b.size, b.size);
        const primary = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim() || '#a88cff';
        ctx.shadowColor = primary;
        ctx.shadowBlur = b.size * 0.4;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 0;
        ctx.globalAlpha = 0.5;
        ctx.globalCompositeOperation = 'lighter';
        ctx.drawImage(b.img, b.x, b.y, b.size, b.size);
        ctx.shadowBlur = 0;
        ctx.globalCompositeOperation = 'source-over';
        ctx.globalAlpha = 0.11;
        ctx.restore();
        if (b.y + b.size < -50 || b.opacity <= 0) {
          window.nukeBubbles.splice(i, 1);
        }
      }
    }
  }

  animationFrameId = requestAnimationFrame(draw);
}

function drawTintedImage(ctx, originalImg, x, y, width, height) {
  if (!originalImg || !originalImg.complete) {
    ctx.drawImage(originalImg, x, y, width, height);
    return;
  }
  ctx.save();
  ctx.beginPath();
  ctx.rect(x, y, width, height);
  ctx.clip();
  ctx.drawImage(originalImg, x, y, width, height);
  const primary = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();
  ctx.globalCompositeOperation = 'source-in';
  ctx.fillStyle = primary;
  ctx.fillRect(x, y, width, height);
  ctx.restore();
}
function getRandomBubbleImage(version) {
  const loaded = version.filter(img => img.complete);
  if (loaded.length === 0) return null;
  return loaded[Math.floor(Math.random() * loaded.length)];
}

let isMainWindowVisible = true;

document.addEventListener('visibilitychange', () => {
  isMainWindowVisible = !document.hidden;
  if (!isMainWindowVisible) {
       document.body.classList.add('minimized');
    stopVisualizer();
  } else {
    document.body.classList.remove('minimized');
    if (visualizerToggle) visualize();
  }
});

  function adjustColor(color, percent) {
    if (color.startsWith('hsl')) {
      const match = color.match(/hsl\((\d+),\s*(\d+)%,\s*(\d+)%\)/);
      if (!match) return color;
      let [, hue, saturation, lightness] = match;
      hue = parseInt(hue);
      saturation = parseInt(saturation);
      lightness = parseInt(lightness);
      lightness = Math.min(100, Math.max(0, lightness + percent));
      return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
    }

    let hex = color.replace('#', '');
    if (hex.length === 3) {
      hex = hex.split('').map(c => c + c).join('');
    }
    if (!/^[0-9a-fA-F]{6}$/.test(hex)) return color;

    let r = parseInt(hex.slice(0, 2), 16);
    let g = parseInt(hex.slice(2, 4), 16);
    let b = parseInt(hex.slice(4, 6), 16);

    r = Math.min(255, Math.max(0, Math.round(r * (1 + percent / 100))));
    g = Math.min(255, Math.max(0, Math.round(g * (1 + percent / 100))));
    b = Math.min(255, Math.max(0, Math.round(b * (1 + percent / 100))));

    return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
  }

  const notifyToggleBtn = document.getElementById('notifyToggleBtn');
  const bellIcon = document.getElementById('bellIcon');
  bellIcon.src = notifyEnabled ? 'build/bell-ring.svg' : 'build/bell.svg';

  notifyToggleBtn.addEventListener('click', () => {
    notifyEnabled = !notifyEnabled;
    localStorage.setItem('notifyEnabled', notifyEnabled);
    bellIcon.src = notifyEnabled ? 'build/bell-ring.svg' : 'build/bell.svg';
    if (notifyEnabled && 'Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission().then(permission => {
        if (permission !== 'granted') {
          notifyEnabled = false;
          localStorage.setItem('notifyEnabled', 'false');
          alert('Notifications not enabled in browser.');
        }
      });
    }
  });

let gifPreviewEnabled = localStorage.getItem('gifPreviewEnabled') === 'true';
document.getElementById('gifIcon').src = 'build/gif.svg';
updateGifIcon();

gifPreviewToggleBtn.addEventListener('click', async () => {
    const wasEnabled = gifPreviewEnabled;

    gifPreviewEnabled = !gifPreviewEnabled;
    localStorage.setItem('gifPreviewEnabled', gifPreviewEnabled);
    updateGifIcon();
    if (audio.paused || currentIndex >= audioFiles.length) return;

    const currentTrack = audioFiles[currentIndex];
    if (typeof currentTrack !== 'string') return;

    if (gifPreviewEnabled && !wasEnabled) {
        stopVideo(); 

        const dir = await window.electronAPI.pathDirname(currentTrack);
        const ext = await window.electronAPI.pathExtname(currentTrack);
        const baseName = await window.electronAPI.pathBasename(currentTrack, ext);

        const possibleVideos = [
            baseName + '.mp4',
            baseName + '.webm',
            baseName + '-video.mp4',
            baseName + '-preview.mp4'
        ];

        let videoLoaded = false;

        for (const name of possibleVideos) {
            const candidatePath = await window.electronAPI.pathJoin(dir, name);
            if (await window.electronAPI.fileExists(candidatePath)) {
                videoLoaded = true;
                const url = `file://${candidatePath.replace(/\\/g, '/').replace(/#/g, '%23')}`;
                visualizerVideo.src = url;
                visualizerVideo.style.display = 'block';
                visualizerVideo.style.opacity = '1';
                visualizerVideo.style.zIndex = '1';
                visualizerVideo.loop = true;
                visualizerVideo.muted = true;
                visualizerVideo.playsInline = true;
                clearBackground()

                visualizerVideo.onloadedmetadata = () => {
                    const videoDuration = visualizerVideo.duration;
                    const songDuration = audio.duration;

                    if (isFinite(videoDuration) && isFinite(songDuration) &&
                        Math.abs(videoDuration - songDuration) / songDuration <= 0.12) {
                        const targetTime = audio.currentTime % videoDuration;
                        visualizerVideo.currentTime = targetTime;
                    } else {
                        visualizerVideo.currentTime = 0;
                    }

                    visualizerVideo.play().catch(err => {
                        console.warn("Video play blocked:", err);
                    });
                };

                break;
            }
        }
    }
    else if (!gifPreviewEnabled && wasEnabled) {
        stopVideo();
        visualizerVideo.style.display = 'none';
        visualizerVideo.style.opacity = '0';
        visualizerVideo.style.zIndex = '-1';
        await setVisualizerBackground(currentTrack);
    }
});

function updateGifIcon() {
  const img = document.getElementById('gifIcon');
  
  if (gifPreviewEnabled) {
    img.style.filter = 'none';
    img.style.opacity = '1';
  } else {
    img.style.filter = 'brightness(0) invert(1)';
    img.style.opacity = '0.6';
  }
}


  const visualizerToggleBtn = document.getElementById('visualizerToggleBtn');
  const visualizerIcon = document.getElementById('visualizerIcon');
  visualizerIcon.src = visualizerToggle ? 'build/visualizer.svg' : 'build/visualizeroff.svg';

  visualizerToggleBtn.addEventListener('click', () => {
  visualizerToggle = !visualizerToggle;
  localStorage.setItem('visualizerToggle', visualizerToggle);
  visualizerIcon.src = visualizerToggle ? 'build/visualizer.svg' : 'build/visualizeroff.svg';

  if (visualizerToggle) {
    if (!audio.paused) visualize();
    audio.addEventListener('play', visualize);
  } else {
    audio.removeEventListener('play', visualize);
    if (!animationFrameId && !audio.paused) visualize();
  }
});

  if (visualizerToggle) {
    audio.addEventListener('play', visualize);
  }

audio.addEventListener('ended', () => {
  if (repeatTrack) {
    playTrack(currentIndex);
  } else {
    currentIndex++;
    if (currentIndex >= audioFiles.length) {
      currentIndex = 0;
    }
    playTrack(currentIndex);
  }
});

  async function applySavedSort() {
    const criteria = localStorage.getItem('sortCriteria');
    const order = localStorage.getItem('sortOrder');

    if (criteria && order) {
      const sortIdMap = {
        'name-asc': 'sortNameAsc',
        'name-desc': 'sortNameDesc',
        'date-asc': 'sortDateAsc',
        'date-desc': 'sortDateDesc'
      };

      const key = `${criteria}-${order}`;
      const buttonId = sortIdMap[key];

      if (buttonId) {
        updateSortCheckmark(buttonId);
      }

      return await sortPlaylist(criteria, order === 'asc');
    }
    return 0;
  }

  function updateStoredPlaylist() {
    try {
      localStorage.setItem('sortedPlaylist', JSON.stringify(audioFiles));
    } catch (e) {
      console.error('Failed to save playlist:', e);
    }
  }

function scrollToCurrentTrack(forceTop = false) {
  const currentItem = playlistElem.querySelector(`li[data-real-index="${currentIndex}"]`);
  
  if (!currentItem) return;

  if (forceTop) {
    playlistElem.scrollTop = 0;
    return;
  }

  const isShortList = playlistElem.scrollHeight <= playlistElem.clientHeight + 50;
  const searchActive = currentSearchTerm !== '';

  if (isShortList || searchActive) {
    currentItem.scrollIntoView({
      behavior: 'smooth',
      block: 'center', 
      inline: 'nearest'
    });
  } else {
    currentItem.scrollIntoView({
      behavior: 'smooth',
      block: 'start'
    });
  }
}

  let rainbowHue = 0;
function stopVisualizer() {
  if (animationFrameId) {
    cancelAnimationFrame(animationFrameId);
    animationFrameId = null;
  }
  ctx.clearRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
  window.electronAPI.disableVisualizer();
}





function startRainbowColorLoop() {
  if (!isRainbowActive || rainbowIntervalId) return;

  rainbowIntervalId = setInterval(() => {
    rainbowHue = (rainbowHue + 5) % 360;
    const color = `hsl(${rainbowHue}, 100%, 65%)`;
    const darkColor = `hsl(${rainbowHue}, 100%, 45%)`;

    document.documentElement.style.setProperty('--primary-color', color);
    document.documentElement.style.setProperty('--primary-dark', darkColor);

    updateSliderBackground(volumeSlider);
    updateSliderBackground(progressBar);
  }, 100);
}

function stopRainbowLoop() {
  if (rainbowIntervalId) {
    clearInterval(rainbowIntervalId);
    rainbowIntervalId = null;
  }
}

  window.electronAPI.onUpdateTrack((data) => {
    if (data.isPlaying !== undefined) {
      if (data.isPlaying && audio.paused) {
        audio.play();
      } else if (!data.isPlaying && !audio.paused) {
        audio.pause();
      }
    }
  });

  window.electronAPI.onUpdateVolume((volume) => {
    audio.volume = volume;
    volumeSlider.value = volume;
    volumePercent.textContent = Math.round(volume * 100) + '%';
    localStorage.setItem('volumeLevel', volume);
    updateSliderBackground(volumeSlider);
  });

  window.electronAPI.onRequestCurrentState(() => {
  if (audioFiles[currentIndex]) {
    const filePath = audioFiles[currentIndex];
    setVisualizerBackground(filePath).then(() => {
      const trackData = {
        songName: filePath.split(/[\\/]/).pop(),
        artUrl: visualizerCanvas.style.backgroundImage.slice(5, -2),
        isPlaying: !audio.paused,
        filePath: filePath,
        volume: audio.volume
      };
      window.electronAPI.updateTrack(trackData);
      window.electronAPI.updateTheme({ color: themeColor, isRainbow: isRainbowActive });
    });
  } else {
  
    window.electronAPI.updateTrack({ songName: 'No Track', artUrl: null, isPlaying: false });
    window.electronAPI.updateTheme({ color: themeColor, isRainbow: isRainbowActive });
  }
});

  window.electronAPI.onPlayPrevious(() => {
    if (currentIndex > 0) {
      currentIndex--;
      playTrack(currentIndex);
    }
  });

  window.electronAPI.onSeekFromMini((time) => {
  if (!isNaN(time) && audio.duration) {
    audio.currentTime = time;    
    progressBar.value = time;    
    currentTimeElem.textContent = formatTime(time);
    updateSliderBackground(progressBar);
  }
})

  window.electronAPI.onPlayNext(() => {
    if (currentIndex < audioFiles.length - 1) {
      currentIndex++;
      playTrack(currentIndex);
    } else if (repeatTrack) {
      currentIndex = 0;
      playTrack(currentIndex);
    }
  });

  window.electronAPI.onTogglePlay(() => {
    if (audio.paused) {
      audio.play();
    } else {
      audio.pause();
    }
  });

document.addEventListener('DOMContentLoaded', () => {
  const toggleRow = document.getElementById('autoUpdateAppToggle');
  const checkbox = document.getElementById('autoUpdateAppCheckbox');

  let isEnabled = localStorage.getItem('autoUpdateEnabled') === 'true';
  checkbox.checked = isEnabled;
  toggleRow.classList.toggle('active', isEnabled);
  window.electronAPI?.setAutoUpdateEnabled?.(isEnabled);
  toggleRow.addEventListener('click', (e) => {
    if (e.target.closest('.switch')) return;

    isEnabled = !isEnabled;
    localStorage.setItem('autoUpdateEnabled', isEnabled ? 'true' : 'false');

    checkbox.checked = isEnabled;
    toggleRow.classList.toggle('active', isEnabled);
    window.electronAPI?.setAutoUpdateEnabled?.(isEnabled);

    if (isEnabled) {
      window.electronAPI?.checkForUpdates?.();
      if (notifyEnabled && Notification.permission === 'granted') {
        window.electronAPI.notify("Auto-updates ON – checking now");
      }
    } else {
      if (notifyEnabled && Notification.permission === 'granted') {
        window.electronAPI.notify("Auto-updates OFF – no more bullshit checks");
      }
    }
  });
});

function checkForUpdatesSilently() {
  if (typeof autoUpdater !== 'undefined' && autoUpdater.checkForUpdates) {
    autoUpdater.checkForUpdatesAndNotify().catch(() => {
    });
  }
}


</script>



<div id="streamModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 9999;">
  <div style="background: #222; padding: 20px; border-radius: 3px; width: 90%; max-width: 400px; color: white;">
    <h3 style="margin-top: 0; color: var(--primary-color);">Add Radio Stream</h3>
    <label>Stream URL (.mp3, .aac, .pls, .m3u etc.):</label>
    <input type="text" id="streamUrlInput" style="width: 100%; padding: 10px; margin: 10px 0; background: #333; border: none; border-radius: 5px; color: white;" placeholder="https://example.com/stream.mp3" />
    
    <label>Station Name (optional):</label>
    <input type="text" id="streamNameInput" style="width: 100%; padding: 10px; margin: 10px 0; background: #333; border: none; border-radius: 5px; color: white;" placeholder="My Favorite Station" />
    
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button id="cancelStreamBtn" style="background: #444; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Cancel</button>
      <button id="addStreamConfirmBtn" style="background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Add</button>
    </div>
  </div>
</div>
</body>
</html>